(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function s(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(i){if(i.ep)return;i.ep=!0;const o=s(i);fetch(i.href,o)}})();const Ft="0x3a9A81d576d83FF21f26f325066054540720fC34",Le="0x344587b3d00394821557352354331D7048754d24",St="0x63f74A64fd334122aB5D29760C6E72Fb4b752208",Ht=[{inputs:[{internalType:"address",name:"to",type:"address"},{internalType:"uint256",name:"value",type:"uint256"},{internalType:"bytes",name:"data",type:"bytes"}],name:"transferAndCall",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"},{constant:!0,inputs:[{name:"_owner",type:"address"}],name:"balanceOf",outputs:[{name:"balance",type:"uint256"}],stateMutability:"view",type:"function"}],_=[{inputs:[],name:"totalSupply",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"totalValueInQueuesAndSponsorships",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"uint256",name:"operatorTokenAmount",type:"uint256"}],name:"undelegate",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"account",type:"address"}],name:"balanceOf",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"delegator",type:"address"}],name:"balanceInData",outputs:[{internalType:"uint256",name:"amountDataWei",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"uint256",name:"maxIterations",type:"uint256"}],name:"payOutQueue",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"sponsorship",type:"address"},{internalType:"uint256",name:"amountWei",type:"uint256"}],name:"stake",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"sponsorship",type:"address"},{internalType:"uint256",name:"targetStakeWei",type:"uint256"}],name:"reduceStakeTo",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address[]",name:"sponsorshipAddresses",type:"address[]"}],name:"withdrawEarningsFromSponsorships",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"string",name:"metadataJsonString",type:"string"}],name:"updateMetadata",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"uint256",name:"operatorsCutFractionWei",type:"uint256"}],name:"updateOperatorsCutFraction",outputs:[],stateMutability:"nonpayable",type:"function"}],ke=[{inputs:[],name:"minimumDelegationWei",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"}],ae="EGWFdhhiWypDuz22Uy7b3F69E9MEkyfU9iAQMttkH5Rj",_t="binance-streamr.eth/DATAUSDT/ticker",oe="https://polygon-rpc.com",Me={apiUrl:"https://api.etherscan.io/v2/api",nativeToken:"MATIC",chainId:137},Te={"0xa9059cbb":"Transfer","0x4000aea0":"Delegate","0x918b5be1":"Update Metadata","0x25c33549":"Set Node Address","0xe8e658b4":"Collect Earnings","0xbed6ff09":"Vote On Flag","0x0fd6ff49":"Heartbeat","0x6c68c0e1":"Undelegate","0xadc9772e":"Stake","0xa93a019f":"Force Unstake","0xd1b68611":"Unstake","0x4a178fe4":"Flag"},De=new Set(["50000000000000000","500000000000000000","150000000000000000","36000000000000000000","2000000000000000000"]),Be=100,Tt=20,Ae=3,Oe=42;function D(t){return typeof t!="string"?"":t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}const O=t=>{if(!t)return"0";const e=t.toString().split(".");return e[0]=e[0].replace(/\B(?=(\d{3})+(?!\d))/g," "),e.join(".")},B=(t,e=!1)=>{if(!t||t==="0")return"0";try{const s=BigInt(t),a=BigInt("1000000000000000000");if(!e)return(s/a).toString();const i=s/a,l=s%a*BigInt(100)/a;return`${i.toString()}.${l.toString().padStart(2,"0")}`}catch(s){return console.error("Could not convert wei to DATA:",t,s),"N/A"}},ie=(t,e)=>{if(e===null||!t)return"Not available";const a=parseFloat(t.replace(/ /g,"").replace(",","."))*e;return`~$${O(Math.round(a))}`},z=(t,e="address")=>{if(!t)return"";const s=`${t.substring(0,6)}...${t.substring(t.length-4)}`;return`<a href="${`https://polygonscan.com/${e}/${t}`}" target="_blank" rel="noopener noreferrer" class="text-gray-300 hover:text-white transition-colors" title="${D(t)}">${s}</a>`};function ht(t){if(!t||!t.id)return"Unknown";const{name:e}=X(t.metadataJsonString),s=t.id,a=`${s.substring(0,6)}...${s.substring(s.length-4)}`,i=D(e||a),o=D(e?`${e} (${s})`:s);return`<a href="#" class="text-gray-300 hover:text-white transition-colors operator-link" data-operator-id="${s}" title="${o}">${i}</a>`}function Ne(t){return typeof t!="string"?!1:/^Qm[1-9A-HJ-NP-Za-km-z]{44}$/.test(t)||/^b[a-z2-7]{58,}$/.test(t)}function X(t){try{if(t){const e=JSON.parse(t),s=Object.prototype.hasOwnProperty.call(e,"__proto__"),a=Object.prototype.hasOwnProperty.call(e,"constructor"),i=Object.prototype.hasOwnProperty.call(e,"prototype");if(s||a||i)return console.warn("Potential prototype pollution attempt detected in metadata."),{name:null,description:null,imageUrl:null};let o=null;return e.imageIpfsCid&&Ne(e.imageIpfsCid)&&(o=`https://ipfs.io/ipfs/${e.imageIpfsCid}`),{name:e.name||null,description:e.description||null,imageUrl:o}}}catch{}return{name:null,description:null,imageUrl:null}}function W(t){return t.code===4001?"Transaction rejected in your wallet.":t.reason?t.reason.toLowerCase().includes("slash")?"Operation failed. The operator may have been slashed.":t.reason.toLowerCase().includes("minimum")?"Operation failed. The amount may be less than the required minimum.":t.reason.toLowerCase().includes("capacity")?"Operation failed. The operator may be at full capacity.":`Transaction failed: ${t.reason}`:t.data&&t.data.message?`Transaction failed: ${t.data.message}`:t.message?t.message:"An unknown error occurred."}function Wt(t){if(!t||t.length===0)return 0;let e=0,s=0;for(const a of t)if(a.sponsorship?.spotAPY){const i=Number(a.amountWei),o=Number(a.sponsorship.spotAPY);e+=i*o,s+=i}return s>0?e/s:0}function re(t){if(!t)return null;try{const e=t.split(" ");if(e.length!==2)return null;const s=e[0].split("/"),a=e[1].split(":");if(s.length!==3||a.length!==2)return null;const i=parseInt(s[0],10),o=parseInt(s[1],10)-1,l=2e3+parseInt(s[2],10),n=parseInt(a[0],10),r=parseInt(a[1],10);return isNaN(i)||isNaN(o)||isNaN(l)||isNaN(n)||isNaN(r)?null:new Date(l,o,i,n,r)}catch(e){return console.error("Failed to parse CSV date:",t,e),null}}const Pe=Object.freeze(Object.defineProperty({__proto__:null,calculateWeightedApy:Wt,convertWeiToData:B,createAddressLink:z,createEntityLink:ht,escapeHtml:D,formatBigNumber:O,formatUsdForTooltip:ie,getFriendlyErrorMessage:W,parseDateFromCsv:re,parseOperatorMetadata:X},Symbol.toStringTag,{value:"Module"})),$e="modulepreload",Re=function(t){return"/"+t},jt={},Fe=function(e,s,a){let i=Promise.resolve();if(s&&s.length>0){let d=function(c){return Promise.all(c.map(g=>Promise.resolve(g).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};var l=d;document.getElementsByTagName("link");const n=document.querySelector("meta[property=csp-nonce]"),r=n?.nonce||n?.getAttribute("nonce");i=d(s.map(c=>{if(c=Re(c),c in jt)return;jt[c]=!0;const g=c.endsWith(".css"),h=g?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${h}`))return;const p=document.createElement("link");if(p.rel=g?"stylesheet":$e,g||(p.as="script"),p.crossOrigin="",p.href=c,r&&p.setAttribute("nonce",r),document.head.appendChild(p),g)return new Promise((f,v)=>{p.addEventListener("load",f),p.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${c}`)))})}))}function o(n){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=n,window.dispatchEvent(r),!r.defaultPrevented)throw n}return i.then(n=>{for(const r of n||[])r.status==="rejected"&&o(r.reason);return e().catch(o)})};let Dt=localStorage.getItem("the-graph-api-key")||"bb77dd994c8e90edcbd73661a326f068",le=`https://gateway-arbitrum.network.thegraph.com/api/${Dt}/subgraphs/id/${ae}`,gt=localStorage.getItem("etherscan-api-key")||"B8BXCXWR66RI1J2QYQRTT4SPHCC6VYYJHC",G=null,Y=null,st=null,rt=null;function He(t){Dt=t||"bb77dd994c8e90edcbd73661a326f068",le=`https://gateway-arbitrum.network.thegraph.com/api/${Dt}/subgraphs/id/${ae}`,console.log("Graph API Key updated.")}function We(t){gt=t||"4IYW9RG6W87Y9B9IGCSD6Z8PVJEIBW5S41",console.log("Etherscan API Key updated.")}async function bt(){try{if(!window.ethereum)return I("Wallet not detected","Please install a wallet like MetaMask."),!1;if((await new ethers.providers.Web3Provider(window.ethereum).getNetwork()).chainId!==137){I("Incorrect Network","Please switch your wallet to the Polygon Mainnet to use this feature.");try{return await window.ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:"0x89"}]}),window.location.reload(),!0}catch(s){if(s.code===4902)try{return await window.ethereum.request({method:"wallet_addEthereumChain",params:[{chainId:"0x89",chainName:"Polygon Mainnet",rpcUrls:["https://polygon-rpc.com"],nativeCurrency:{name:"MATIC",symbol:"MATIC",decimals:18},blockExplorerUrls:["https://polygonscan.com/"]}]}),window.location.reload(),!0}catch(a){console.error("Failed to add Polygon network",a),I("Error","Failed to add the Polygon network to your wallet.")}else I("Error","Failed to switch network. Please do it manually in your wallet.");return console.error("Failed to switch network",s),!1}}return!0}catch(t){return console.error("Could not check network:",t),!1}}async function Ue(){if(rt)return rt;try{const t=await fetch("/DATAHistoricalPrice.csv");if(!t.ok)throw new Error(`Failed to fetch DATAHistoricalPrice.csv: ${t.statusText}`);const s=(await t.text()).split(`
`).slice(1),a=new Map;for(const i of s){const o=i.split(",");if(o.length<2)continue;const l=o[0].trim(),n=o[1].trim();if(l&&n){const r=re(l),d=parseFloat(n);if(r&&!isNaN(d)){const c=new Date(r);c.setUTCHours(0,0,0,0);const g=Math.floor(c.getTime()/1e3),h=a.get(g)||0;d>h&&a.set(g,d)}}}return console.log(`Processed ${a.size} historical price points.`),rt=a,rt}catch(t){return console.error("Error fetching or processing historical price data:",t),I("Price Data Error",`Failed to load historical price data: ${t.message}`),new Map}}async function nt(t){const e=await fetch(le,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:t})});if(!e.ok)throw new Error(`Network error: ${e.statusText}`);const s=await e.json();if(s.errors)throw new Error(`GraphQL error: ${s.errors.map(a=>a.message).join(", ")}`);return s.data}const Ve=t=>{const e=t.toLowerCase();return e.startsWith("0x")&&/^[0-9a-f]+$/.test(e.substring(2))};async function _e(t=0,e=""){if(e&&e.length>0&&e.length<Ae)return[];if(e){const s=e.toLowerCase();if(Ve(s))if(s.length===Oe){const a=`where: {id: "${s}"}`,i=`
                query GetOperatorsList {
                    operators(first: ${Tt}, skip: ${t}, orderBy: valueWithoutEarnings, orderDirection: desc, ${a}) {
                        id valueWithoutEarnings delegatorCount metadataJsonString stakes(first: 50) { amountWei sponsorship { spotAPY } }
                    }
                }`;return(await nt(i)).operators}else return[];else{const i=await nt(`
                query GetTopOperatorsForClientSearch {
                    operators(first: 1000, orderBy: valueWithoutEarnings, orderDirection: desc) {
                        id valueWithoutEarnings delegatorCount metadataJsonString stakes(first: 50) { amountWei sponsorship { spotAPY } }
                    }
                }`),{parseOperatorMetadata:o}=await Fe(async()=>{const{parseOperatorMetadata:l}=await Promise.resolve().then(()=>Pe);return{parseOperatorMetadata:l}},void 0);return i.operators.filter(l=>{const{name:n}=o(l.metadataJsonString);return n?n.toLowerCase().includes(s):!1})}}else{const s=`
            query GetOperatorsList {
                operators(first: ${Tt}, skip: ${t}, orderBy: valueWithoutEarnings, orderDirection: desc) {
                    id valueWithoutEarnings delegatorCount metadataJsonString stakes(first: 50) { amountWei sponsorship { spotAPY } }
                }
            }`;return(await nt(s)).operators}}function de(t){return typeof t=="string"&&/^0x[a-fA-F0-9]{40}$/.test(t)}async function je(t){if(!de(t))throw new Error("Invalid operator ID format. Must be a valid Ethereum address.");const e=t.toLowerCase(),s=`
        query GetOperatorDetails {
          operator(id: "${e}") {
            id owner valueWithoutEarnings operatorTokenTotalSupplyWei delegatorCount cumulativeEarningsWei cumulativeProfitsWei cumulativeOperatorsCutWei operatorsCutFraction nodes controllers metadataJsonString
            stakes(first: 100) { amountWei sponsorship { id remainingWei spotAPY isRunning stream { id } } }
            delegations(where: {isSelfDelegation: false}, first: 15, orderBy: _valueDataWei, orderDirection: desc) { id _valueDataWei delegator { id } }
            queueEntries(orderBy: date, orderDirection: asc) { id amount delegator { id } date }
          }
          selfDelegation: delegations(where: {operator: "${e}", isSelfDelegation: true}, first: 1) { _valueDataWei }
          stakingEvents(orderBy: date, orderDirection: desc, first: 800, where: {operator: "${e}"}) {
            id
            amount
            date
            sponsorship { id stream { id } }
          }
          operatorDailyBuckets(first: 1000, orderBy: date, orderDirection: asc, where: {operator: "${e}"}) {
            date
            valueWithoutEarnings
          }
          flagsAgainst: flags(where: {target: "${e}"}, orderBy: flaggingTimestamp, orderDirection: desc) {
                id
                flagger { id, metadataJsonString }
                sponsorship { id stream { id } }
                flaggingTimestamp
                result
                votes(orderBy: timestamp, orderDirection: desc) {
                    id
                    voter { id, metadataJsonString }
                    voterWeight
                    votedKick
                    timestamp
                }
          }
          flagsAsFlagger: flags(where: {flagger: "${e}"}, orderBy: flaggingTimestamp, orderDirection: desc, first: 100) {
            id
            target { id, metadataJsonString }
            sponsorship { id stream { id } }
            flaggingTimestamp
            result
             votes(orderBy: timestamp, orderDirection: desc) {
                id
                voter { id, metadataJsonString }
                voterWeight
                votedKick
                timestamp
            }
          }
          slashingEvents(where: {operator: "${e}"}, orderBy: date, orderDirection: desc, first: 100) { id amount date sponsorship { id stream { id } } }
        }`;return await nt(s)}async function Ge(t,e){if(!de(t))throw new Error("Invalid operator ID format.");const a=`
        query GetMoreDelegators {
            operator(id: "${t.toLowerCase()}") {
                delegations(where: {isSelfDelegation: false}, first: ${Be}, skip: ${e}, orderBy: _valueDataWei, orderDirection: desc) {
                    id _valueDataWei delegator { id }
                }
            }
        }`;return(await nt(a)).operator.delegations}async function qe(t){if(!gt)return console.warn("Etherscan API Key not set. Skipping transaction history fetch."),[];const{apiUrl:e,chainId:s,nativeToken:a}=Me,i=1,o=500,l="desc",n=`${e}?chainid=${s}&module=account&action=txlist&address=${t}&page=${i}&offset=${o}&sort=${l}&apikey=${gt}`,r=`${e}?chainid=${s}&module=account&action=tokentx&address=${t}&page=${i}&offset=${o}&sort=${l}&apikey=${gt}`;try{const[d,c]=await Promise.all([fetch(n,{cache:"no-cache"}),fetch(r,{cache:"no-cache"})]);if(!d.ok)throw new Error(`API request failed (txlist): HTTP ${d.status}`);if(!c.ok)throw new Error(`API request failed (tokentx): HTTP ${c.status}`);const g=await d.json(),h=await c.json();if(g.status==="0")throw new Error(`API Error (txlist): ${g.result}`);if(h.status==="0")throw new Error(`API Error (tokentx): ${h.result}`);const p=g.result||[],f=h.result||[],v=new Map,x=p.map(S=>{const T=S.from.toLowerCase()===t.toLowerCase()?"OUT":"IN",k=S.input==="0x"||!S.input?"-":S.input.substring(0,10),N=Te[k]||k;N!=="-"&&v.set(S.hash,N);const M=parseFloat(S.value)/1e18;return{txHash:S.hash,timestamp:parseInt(S.timeStamp),token:a,direction:T,methodId:N,amount:M,rawValue:S.value}}),m=new Map;for(const S of f)m.has(S.hash)||m.set(S.hash,[]),m.get(S.hash).push(S);const E=[];for(const[S,T]of m.entries()){const k=v.get(S)||"-";let N=k;N==="-"&&T.length>1&&T.map(P=>P.from.toLowerCase()===t.toLowerCase()?"OUT":"IN").every(P=>P==="IN")&&(N="Force Unstake");for(const M of T){const R=M.from.toLowerCase()===t.toLowerCase()?"OUT":"IN",P=parseInt(M.tokenDecimal)||18,y=parseFloat(M.value)/Math.pow(10,P);let b=N;R==="OUT"&&M.tokenSymbol==="DATA"&&M.to.toLowerCase()===St.toLowerCase()?b="Protocol Tax":b==="-"&&M.tokenSymbol==="DATA"&&De.has(M.value)?b="Vote On Flag":(k==="Delegate"||k==="Transfer")&&R==="IN"||b==="-"&&R==="IN"&&M.tokenSymbol==="DATA"&&T.length===1?b="Delegate":(k==="Collect Earnings"&&R==="OUT"||(k==="Unstake"||k==="Force Unstake")&&R==="OUT")&&(M.to.toLowerCase()===St.toLowerCase()?b="Protocol Tax":b="Undelegate"),E.push({txHash:M.hash,timestamp:parseInt(M.timeStamp),token:M.tokenSymbol,direction:R,methodId:b,amount:y,rawValue:M.value})}}return[...x,...E].filter(S=>{const T=S.token.toUpperCase(),k=a.toUpperCase();return T==="DATA"||T===k&&S.amount>0})}catch(d){return console.error("Error fetching Polygonscan history:",d),I("Etherscan API Error",`Failed to fetch transaction history: ${d.message}. Please check your API key in Settings.`),[]}}async function ze(t){try{const e=await fetch(oe,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jsonrpc:"2.0",method:"eth_getBalance",params:[t,"latest"],id:1})});if(!e.ok)return"Error";const s=await e.json();if(s.error)return console.error("RPC Error:",s.error),"Error";const a=BigInt(s.result);return(Number(a)/1e18).toFixed(2)}catch(e){return console.error(`Failed to get MATIC balance for ${t}:`,e),"Error"}}async function ce(t,e="delegate",s,a,i){const o=document.getElementById("tx-modal-title"),l=document.getElementById("tx-modal-description"),n=document.getElementById("tx-modal-balance-label");o.textContent=e==="delegate"?"Delegate to Operator":"Undelegate from Operator",l.textContent=e==="delegate"?"Enter the amount of DATA to delegate.":"Enter the amount of DATA to undelegate.",n.textContent="Your Balance:",It.textContent="Loading...";const r=Lt.parentElement;r.style.display=e==="delegate"?"flex":"none",w("tx-modal","input"),Q.classList.remove("hidden");try{const d=s.provider;let c;if(e==="delegate"){c=await new ethers.Contract(Ft,Ht,d).balanceOf(a);try{const f=await new ethers.Contract(Le,ke,d).minimumDelegationWei();Lt.textContent=`${parseFloat(ethers.utils.formatEther(f)).toFixed(0)} DATA`}catch(p){console.error("Failed to get minimum delegation",p),Lt.textContent="N/A"}}else c=await new ethers.Contract(i,_,d).balanceInData(a);const g=ethers.utils.formatEther(c);return It.textContent=`${parseFloat(g).toFixed(4)} DATA`,c.toString()}catch(d){return console.error(`Failed to get balance for ${e}:`,d),It.textContent="Error","0"}}const ue="100000000000";async function Je(t,e,s){const a=wt.value.replace(",",".");if(!a||isNaN(a)||parseFloat(a)<=0)return I("Invalid Amount","Please enter a valid amount greater than zero."),null;if(/[eE]/.test(a)||parseFloat(a)>parseFloat(ue))return I("Invalid Amount","Please enter a reasonable amount without scientific notation."),null;w("tx-modal","loading",{text:"Checking balance...",subtext:"Please wait."});try{const i=new ethers.Contract(Ft,Ht,t);let o;try{o=ethers.utils.parseEther(a)}catch{return I("Invalid Amount","Could not parse the amount. Please enter a valid number."),w("tx-modal","input"),null}const l=await i.balanceOf(e);if(o.gt(l))return I("Insufficient Balance","You do not have enough DATA to delegate that amount."),w("tx-modal","input"),null;w("tx-modal","loading");const n=await i.transferAndCall(s,o,"0x");w("tx-modal","loading",{text:"Processing Transaction...",subtext:"Waiting for confirmation."});const r=await n.wait();return w("tx-modal","success",{txHash:r.transactionHash}),r.transactionHash}catch(i){return console.error("Delegation failed:",i),w("tx-modal","error",{message:W(i)}),null}}async function Ke(t,e,s,a){const i=wt.value.replace(",",".");if(!i||isNaN(i)||parseFloat(i)<=0)return I("Invalid Amount","Please enter a valid amount greater than zero."),null;if(/[eE]/.test(i)||parseFloat(i)>parseFloat(ue))return I("Invalid Amount","Please enter a reasonable amount without scientific notation."),null;w("tx-modal","loading",{text:"Checking stake...",subtext:"Please wait."});try{const o=new ethers.Contract(s,_,t);let l;try{l=ethers.utils.parseEther(i)}catch{return I("Invalid Amount","Could not parse the amount. Please enter a valid number."),w("tx-modal","input"),null}const[n,r]=await Promise.all([o.balanceInData(e),o.balanceOf(e)]);if(l.gt(n))return I("Insufficient Stake","You do not have enough staked DATA to undelegate that amount."),w("tx-modal","input"),null;let d;const c=n.mul(9999).div(1e4);if(l.gte(c))d=r;else{if(n.isZero())throw new Error("User has no DATA balance, cannot calculate conversion");d=l.mul(r).div(n),d.gt(r)&&(d=r)}w("tx-modal","loading");const g=await o.undelegate(d);w("tx-modal","loading",{text:"Processing Transaction...",subtext:"Waiting for confirmation."});const h=await g.wait();return w("tx-modal","success",{txHash:h.transactionHash}),h.transactionHash}catch(o){return console.error("Undelegation failed:",o),w("tx-modal","error",{message:W(o)}),null}}async function Ye(t,e){Q.classList.remove("hidden"),document.getElementById("tx-modal-title").textContent="Process Undelegation Queue",w("tx-modal","loading",{text:"Preparing transaction...",subtext:"This will pay out queued undelegations."});try{const a=await new ethers.Contract(e,_,t).payOutQueue(0);w("tx-modal","loading",{text:"Processing Transaction...",subtext:"Waiting for confirmation."});const i=await a.wait();w("tx-modal","success",{txHash:i.transactionHash})}catch(s){console.error("Queue processing failed:",s),w("tx-modal","error",{message:W(s)})}}async function Qe(t,e,s,a){const i=Bt.value.replace(",",".");if(!i||isNaN(i)||parseFloat(i)<0)return I("Invalid Amount","Please enter a valid number."),null;w("stake-modal","loading",{text:"Preparing transaction...",subtext:"Please wait."});try{const o=new ethers.Contract(e,_,t),l=ethers.utils.parseEther(i),n=ethers.BigNumber.from(a);let r;if(l.gt(n)){const c=l.sub(n);r=await o.stake(s,c)}else if(l.lt(n))r=await o.reduceStakeTo(s,l);else return yt.classList.add("hidden"),"nochange";w("stake-modal","loading");const d=await r.wait();return w("stake-modal","success",{txHash:d.transactionHash}),d.transactionHash}catch(o){return console.error("Stake edit failed:",o),w("stake-modal","error",{message:W(o)}),null}}async function Xe(t,e,s){Q.classList.remove("hidden"),document.getElementById("tx-modal-title").textContent="Collect Earnings",w("tx-modal","loading",{text:"Preparing transaction...",subtext:"Please wait."});try{const i=await new ethers.Contract(e,_,t).withdrawEarningsFromSponsorships([s]);w("tx-modal","loading",{text:"Processing Transaction...",subtext:"Waiting for confirmation."});const o=await i.wait();w("tx-modal","success",{txHash:o.transactionHash})}catch(a){console.error("Earnings collection failed:",a),w("tx-modal","error",{message:W(a)})}}async function Ze(t,e,s){Q.classList.remove("hidden"),document.getElementById("tx-modal-title").textContent="Collect All Earnings",w("tx-modal","loading",{text:"Preparing transaction...",subtext:"This will collect from all sponsorships."});try{const a=new ethers.Contract(e,_,t),i=s.stakes.map(n=>n.sponsorship.id),o=await a.withdrawEarningsFromSponsorships(i);w("tx-modal","loading",{text:"Processing Transaction...",subtext:"Waiting for confirmation."});const l=await o.wait();w("tx-modal","success",{txHash:l.transactionHash})}catch(a){console.error("Collect all earnings failed:",a),w("tx-modal","error",{message:W(a)})}}async function ts(t,e,s){if(!e)return"0";try{const a=s?.provider||new ethers.providers.JsonRpcProvider(oe);return(await new ethers.Contract(t,_,a).balanceInData(e)).toString()}catch(a){return console.error("Failed to get user's stake:",a),"0"}}async function es(t,e,s){try{return(await(await new ethers.Contract(e,_,t).updateMetadata(s)).wait()).transactionHash}catch(a){return console.error("Metadata update failed:",a),w("operator-settings-modal","error",{message:W(a)}),null}}async function ss(t,e,s){try{const a=parseFloat(s);if(isNaN(a)||a<0||a>100)throw new Error("Invalid percentage value. Must be between 0 and 100.");const i=ethers.utils.parseEther((a/100).toString());return(await(await new ethers.Contract(e,_,t).updateOperatorsCutFraction(i)).wait()).transactionHash}catch(a){return console.error("Operator cut update failed:",a),w("operator-settings-modal","error",{message:W(a)}),null}}function ns(t){G=t}function as(){return G}async function os(t){Ct.textContent="Subscribing...";try{Y&&await Y.unsubscribe(),Y=await G.subscribe(_t,e=>{if(e&&e.bestBid!==void 0){const s=parseFloat(e.bestBid);Ct.textContent=`$${s.toFixed(4)}`,t(s)}}),console.log(`Subscribed to DATA price stream: ${_t}`)}catch(e){console.error("Error setting up DATA price stream:",e),Ct.textContent="Stream Error"}}async function is(t,e){const s=`${t}/operator/coordination`;await Ut();const a=document.getElementById("stream-status-indicator");if(!a||!G)return{subscription:null,error:new Error("Client not ready")};a.className="w-3 h-3 rounded-full bg-yellow-500 animate-pulse",a.title=`Connecting to ${s}...`;try{return st=await G.subscribe(s,i=>{a.className="w-3 h-3 rounded-full bg-green-500",a.title="Subscribed, receiving data.",e(i)}),a.className="w-3 h-3 rounded-full bg-gray-400",a.title="Subscribed to stream. Awaiting first message...",{subscription:st,error:null}}catch(i){return console.error(`[Streamr] Error subscribing to ${s}:`,i),a.className="w-3 h-3 rounded-full bg-red-500",a.title="Error subscribing to stream.",{subscription:null,error:i}}}async function Ut(){if(st){try{await st.unsubscribe()}catch{}st=null}}async function rs(){if(await Ut(),Y){try{await Y.unsubscribe()}catch{}Y=null}if(G){try{await G.destroy()}catch{}G=null}}const ls={100:{lat:40.639447,long:-73.779317,code:"JFK"},200:{lat:40.777199,long:-73.872597,code:"LGA"},300:{lat:40.692501,long:-74.168701,code:"EWR"},400:{lat:42.94049835,long:-78.73220062,code:"BUF"},500:{lat:47.529999,long:-122.302002,code:"BFI"},600:{lat:47.449162,long:-122.311134,code:"SEA"},700:{lat:45.58869934,long:-122.5979996,code:"PDX"},800:{lat:45.540401,long:-122.949997,code:"HIO"},900:{lat:38.69540023803711,long:-121.59100341796875,code:"SMF"},1e3:{lat:37.61899948120117,long:-122.375,code:"SFO"},1100:{lat:37.461101532,long:-122.114997864,code:"PAO"},1200:{lat:37.362452,long:-121.929188,code:"SJC"},1300:{lat:36.9356994629,long:-121.790000916,code:"WVI"},1400:{lat:34.197703,long:-118.356378,code:"BUR"},1500:{lat:33.942501,long:-118.407997,code:"LAX"},1600:{lat:32.7336006165,long:-117.190002441,code:"SAN"},1700:{lat:36.083361,long:-115.151817,code:"LAS"},1800:{lat:33.435302,long:-112.005905,code:"PHX"},1900:{lat:35.040199,long:-106.609001,code:"ABQ"},2e3:{lat:39.861698150635,long:-104.672996521,code:"DEN"},2100:{lat:40.785749,long:-111.979746,code:"SLC"},2200:{lat:44.93479,long:-93.060036,code:"STP"},2300:{lat:44.882,long:-93.221802,code:"MSP"},2400:{lat:43.585463,long:-96.741152,code:"FSD"},2500:{lat:41.3032,long:-95.894096,code:"OMA"},2600:{lat:39.2976,long:-94.713898,code:"MCI"},2700:{lat:35.393101,long:-97.6007,code:"OKC"},2800:{lat:32.9686012268,long:-96.8364028931,code:"ADS"},2900:{lat:32.896801,long:-97.038002,code:"DFW"},3e3:{lat:29.984399795532227,long:-95.34140014648438,code:"IAH"},3100:{lat:30.197535,long:-97.662015,code:"AUS"},3200:{lat:29.533701,long:-98.469803,code:"SAT"},3300:{lat:26.176141,long:-98.237965,code:"MFE"},3400:{lat:21.32062,long:-157.924228,code:"HNL"},3500:{lat:61.1744,long:-149.996002,code:"ANC"},3600:{lat:42.3643,long:-71.005203,code:"BOS"},3700:{lat:44.8074,long:-68.828102,code:"BGR"},3800:{lat:43.6772,long:-79.6306,code:"YTO"},3900:{lat:43.6772,long:-79.6306,code:"YYZ"},4e3:{lat:45.322498,long:-75.669197,code:"YOW"},4100:{lat:45.4706,long:-73.740799,code:"YUL"},4200:{lat:44.8807983398,long:-63.5085983276,code:"YHZ"},4300:{lat:49.193901062,long:-123.183998108,code:"YVR"},4400:{lat:51.113899231,long:-114.019996643,code:"YYC"},4500:{lat:52.170799255371094,long:-106.69999694824219,code:"YXE"},4600:{lat:49.909999847399995,long:-97.2398986816,code:"YWG"},4700:{lat:63.985001,long:-22.6056,code:"KEF"},4800:{lat:53.428713,long:-6.262121,code:"DUB"},4900:{lat:51.841301,long:-8.49111,code:"ORK"},5e3:{lat:53.349375,long:-2.279521,code:"MAN"},5100:{lat:51.4706,long:-.461941,code:"LHR"},5200:{lat:51.4706,long:-.461941,code:"LON"},5300:{lat:51.505299,long:.055278,code:"LCY"},5400:{lat:55.950145,long:-3.372288,code:"EDI"},5500:{lat:50.901402,long:4.48444,code:"BRU"},5600:{lat:52.308601,long:4.76389,code:"AMS"},5700:{lat:51.289501,long:6.76678,code:"DUS"},5800:{lat:50.036521,long:8.561268,code:"FRA"},5900:{lat:50.049800872802734,long:8.325400352478027,code:"WIE"},6e3:{lat:48.689899,long:9.22196,code:"STR"},6100:{lat:48.353802,long:11.7861,code:"MUC"},6200:{lat:52.362247,long:13.500672,code:"TXL"},6300:{lat:53.630402,long:9.98823,code:"HAM"},6400:{lat:49.6233333,long:6.2044444,code:"LUX"},6500:{lat:49.012798,long:2.55,code:"DLP"},6600:{lat:49.012798,long:2.55,code:"CDG"},6700:{lat:49.012798,long:2.55,code:"PAR"},6800:{lat:44.8283,long:-.715556,code:"BOD"},6900:{lat:43.438088,long:5.2125,code:"MRS"},7e3:{lat:45.725556,long:5.081111,code:"LYS"},7100:{lat:46.238098,long:6.10895,code:"GVA"},7200:{lat:47.458056,long:8.548056,code:"ZRH"},7300:{lat:45.6306,long:8.72811,code:"MXP"},7400:{lat:45.445099,long:9.27674,code:"LIN"},7500:{lat:41.804532,long:12.251998,code:"FCO"},7600:{lat:38.175999,long:13.091,code:"PMO"},7700:{lat:50.103514,long:14.256992,code:"PRG"},7800:{lat:55.617900848389,long:12.656000137329,code:"CPH"},7900:{lat:60.193901,long:11.1004,code:"OSL"},8e3:{lat:59.651901245117,long:17.918600082397,code:"ARN"},8100:{lat:59.354400634765625,long:17.941699981689453,code:"BMA"},8200:{lat:57.662799835205,long:12.279800415039,code:"GOT"},8300:{lat:56.923599,long:23.9711,code:"RIX"},8400:{lat:59.41329956049999,long:24.832799911499997,code:"TLL"},8500:{lat:60.3172,long:24.963301,code:"HEL"},8600:{lat:59.80030059814453,long:30.262500762939453,code:"LED"},8700:{lat:56.82469940185547,long:35.7577018737793,code:"KLD"},8800:{lat:55.40879821777344,long:37.90629959106445,code:"DME"},8900:{lat:56.743099212646,long:60.802700042725,code:"SVX"},9e3:{lat:56.173077,long:92.492437,code:"KJA"},9100:{lat:48.528338,long:135.188588,code:"KHV"},9200:{lat:53.888071,long:28.039964,code:"MSQ"},9300:{lat:54.634102,long:25.285801,code:"VNO"},9400:{lat:52.1656990051,long:20.967100143399996,code:"WAW"},9500:{lat:50.345001,long:30.894699,code:"KBP"},9600:{lat:46.9277,long:28.931,code:"KIV"},9700:{lat:44.572127,long:26.103396,code:"OTP"},9800:{lat:41.261297,long:28.741951,code:"IST"},9900:{lat:38.2924,long:27.157,code:"ADB"},1e4:{lat:37.936401,long:23.9445,code:"ATH"},10100:{lat:40.51928,long:22.970009,code:"SKG"},10200:{lat:42.696357,long:23.417671,code:"SOF"},10300:{lat:41.4147,long:19.7206,code:"TIA"},10400:{lat:44.818401,long:20.309099,code:"BEG"},10500:{lat:47.43018,long:19.262393,code:"BUD"},10600:{lat:48.1702,long:17.2127,code:"BTS"},10700:{lat:48.110298,long:16.5697,code:"VIE"},10800:{lat:45.742901,long:16.0688,code:"ZAG"},10900:{lat:36.851002,long:10.2272,code:"TUN"},11e3:{lat:36.826781,long:7.81334,code:"AAE"},11100:{lat:36.693886,long:3.214531,code:"ALG"},11200:{lat:35.623901,long:-.621183,code:"ORN"},11300:{lat:40.471926,long:-3.56264,code:"MAD"},11400:{lat:41.2971,long:2.07846,code:"BCN"},11500:{lat:38.7813,long:-9.13592,code:"LIS"},11600:{lat:33.3675,long:-7.58997,code:"CMN"},11700:{lat:14.7397,long:-17.4902,code:"DKR"},11800:{lat:12.3532,long:-1.51242,code:"OUA"},11900:{lat:5.605189800262451,long:-.16678600013256073,code:"ACC"},12e3:{lat:6.5773701667785645,long:3.321160078048706,code:"LOS"},12100:{lat:-4.38575,long:15.4446,code:"FIH"},12200:{lat:-8.85837,long:13.2312,code:"LAD"},12300:{lat:-33.9648017883,long:18.6016998291,code:"CPT"},12400:{lat:-29.6144444444,long:31.1197222222,code:"DUR"},12500:{lat:-26.1392,long:28.246,code:"JNB"},12600:{lat:-25.920799,long:32.572601,code:"MPM"},12700:{lat:-24.555201,long:25.9182,code:"GBE"},12800:{lat:-17.931801,long:31.0928,code:"HRE"},12900:{lat:-18.7969,long:47.478802,code:"TNR"},13e3:{lat:-20.890087,long:55.518894,code:"RUN"},13100:{lat:-20.430201,long:57.683601,code:"MRU"},13200:{lat:-6.87811,long:39.202599,code:"DAR"},13300:{lat:-4.03483,long:39.5942,code:"MBA"},13400:{lat:-1.31923997402,long:36.9277992249,code:"NBO"},13500:{lat:-1.96863,long:30.1395,code:"KGL"},13600:{lat:11.5473,long:43.1595,code:"JIB"},13700:{lat:30.111534,long:31.396694,code:"CAI"},13800:{lat:32.011398,long:34.8867,code:"TLV"},13900:{lat:32.80939865112305,long:35.04309844970703,code:"HFA"},14e3:{lat:31.91123,long:35.20756,code:"ZDM"},14100:{lat:31.7226009369,long:35.9931983948,code:"AMM"},14200:{lat:33.820899963378906,long:35.488399505615234,code:"BEY"},14300:{lat:34.875099,long:33.624901,code:"LCA"},14400:{lat:40.1473007202,long:44.3959007263,code:"EVN"},14500:{lat:41.669201,long:44.9547,code:"TBS"},14600:{lat:40.467498779296875,long:50.04669952392578,code:"GYD"},14700:{lat:38.757919,long:48.807042,code:"LLK"},14800:{lat:36.23759841918945,long:43.963199615478516,code:"EBL"},14900:{lat:35.5617485046,long:45.316738128699996,code:"ISU"},15e3:{lat:33.262501,long:44.2346,code:"BGW"},15100:{lat:31.989853,long:44.404317,code:"NJF"},15200:{lat:30.935801,long:46.090099,code:"XNH"},15300:{lat:30.549101,long:47.662102,code:"BSR"},15400:{lat:29.226601,long:47.968899,code:"KWI"},15500:{lat:24.9576,long:46.698799,code:"RUH"},15600:{lat:26.471200942993164,long:49.79790115356445,code:"DMM"},15700:{lat:21.6796,long:39.156502,code:"JED"},15800:{lat:26.267295,long:50.63764,code:"BAH"},15900:{lat:25.273056,long:51.608056,code:"DOH"},16e3:{lat:25.2527999878,long:55.3643989563,code:"DXB"},16100:{lat:25.1122,long:56.324001,code:"FJR"},16200:{lat:23.593299865722656,long:58.284400939941406,code:"MCT"},16300:{lat:4.191830158233643,long:73.52909851074219,code:"MLE"},16400:{lat:7.180759906768799,long:79.88410186767578,code:"CMB"},16500:{lat:12.990005,long:80.169296,code:"MAA"},16600:{lat:13.1979,long:77.706299,code:"BLR"},16700:{lat:17.231318,long:78.429855,code:"HYD"},16800:{lat:21.092199,long:79.047203,code:"NAG"},16900:{lat:20.244400024399997,long:85.8178024292,code:"BBI"},17e3:{lat:22.654699325561523,long:88.44670104980469,code:"CCU"},17100:{lat:23.0772,long:72.634697,code:"AMD"},17200:{lat:19.0886993408,long:72.8678970337,code:"BOM"},17300:{lat:18.5821,long:73.919701,code:"PNQ"},17400:{lat:11.918614,long:75.547211,code:"CNN"},17500:{lat:10.152,long:76.401901,code:"COK"},17600:{lat:25.591299,long:85.087997,code:"PAT"},17700:{lat:26.404301,long:80.410103,code:"KNU"},17800:{lat:28.55563,long:77.09519,code:"DEL"},17900:{lat:30.6735,long:76.788498,code:"IXC"},18e3:{lat:23.1838,long:89.160797,code:"JSR"},18100:{lat:22.249599,long:91.813301,code:"CGP"},18200:{lat:23.843347,long:90.397783,code:"DAC"},18300:{lat:27.4032,long:89.424599,code:"PBH"},18400:{lat:27.6966,long:85.3591,code:"KTM"},18500:{lat:31.521601,long:74.403603,code:"LHE"},18600:{lat:33.549,long:72.82566,code:"ISB"},18700:{lat:24.9065,long:67.160797,code:"KHI"},18800:{lat:41.257900238,long:69.2811965942,code:"TAS"},18900:{lat:43.354267,long:77.042828,code:"ALA"},19e3:{lat:47.843102,long:106.766998,code:"ULN"},19100:{lat:37.46910095214844,long:126.45099639892578,code:"ICN"},19200:{lat:35.764702,long:140.386002,code:"TYO"},19300:{lat:35.764702,long:140.386002,code:"NRT"},19400:{lat:35.552299,long:139.779999,code:"HND"},19500:{lat:34.785499572753906,long:135.43800354003906,code:"ITM"},19600:{lat:34.427299,long:135.244003,code:"KIX"},19700:{lat:33.585899353027344,long:130.4510040283203,code:"FUK"},19800:{lat:26.195801,long:127.646004,code:"OKA"},19900:{lat:13.4834,long:144.796005,code:"GUM"},2e4:{lat:8.612203,long:124.456496,code:"CGY"},20100:{lat:10.309261,long:123.97974,code:"CEB"},20200:{lat:14.5086,long:121.019997,code:"MNL"},20300:{lat:4.9442,long:114.928001,code:"BWN"},20400:{lat:10.8188,long:106.652,code:"SGN"},20500:{lat:21.221201,long:105.806999,code:"HAN"},20600:{lat:11.5466,long:104.844002,code:"PNH"},20700:{lat:17.988300323500003,long:102.56300354,code:"VTE"},20800:{lat:22.149599,long:113.592003,code:"MFM"},20900:{lat:22.308901,long:113.915001,code:"HKG"},21e3:{lat:22.577101,long:120.349998,code:"KHH"},21100:{lat:25.0777,long:121.233002,code:"TPE"},21200:{lat:25.934669,long:119.66318,code:"FOC"},21300:{lat:28.562201,long:121.429001,code:"HYN"},21400:{lat:30.23609,long:120.428865,code:"HGH"},21500:{lat:31.198104,long:121.33426,code:"SHA"},21600:{lat:31.919701,long:119.778999,code:"CZX"},21700:{lat:31.3906,long:118.408997,code:"WHU"},21800:{lat:28.864815,long:115.90271,code:"KHN"},21900:{lat:28.9189,long:111.639999,code:"CGD"},22e3:{lat:26.541466,long:106.803331,code:"KWE"},22100:{lat:25.110313,long:102.936743,code:"KMG"},22200:{lat:36.515202,long:103.620003,code:"LHW"},22300:{lat:37.573125,long:105.154454,code:"ZHY"},22400:{lat:38.280701,long:114.696999,code:"SJW"},22500:{lat:39.509945,long:116.41092,code:"PKX"},22600:{lat:40.080101013183594,long:116.58499908447266,code:"BJS"},22700:{lat:39.124401092499994,long:117.346000671,code:"TSN"},22800:{lat:36.857201,long:117.216003,code:"TNA"},22900:{lat:36.361953,long:120.088171,code:"TAO"},23e3:{lat:19.9349,long:110.459,code:"HAK"},23100:{lat:23.0833,long:113.07,code:"FUO"},23200:{lat:23.392401,long:113.299004,code:"ZGN"},23300:{lat:23.392401,long:113.299004,code:"CAN"},23400:{lat:22.639299,long:113.810997,code:"SZX"},23500:{lat:21.702199935913086,long:95.97789764404297,code:"MDL"},23600:{lat:16.907300949099998,long:96.1332015991,code:"RGN"},23700:{lat:18.766799926799997,long:98.962600708,code:"CNX"},23800:{lat:13.681099891662598,long:100.74700164794922,code:"BKK"},23900:{lat:9.13259983063,long:99.135597229,code:"URT"},24e3:{lat:2.74558,long:101.709999,code:"KUL"},24100:{lat:1.64131,long:103.669998,code:"JHB"},24200:{lat:1.36042,long:103.910004,code:"QPG"},24300:{lat:1.35019,long:103.994003,code:"SIN"},24400:{lat:-6.1255698204,long:106.65599823,code:"CGK"},24500:{lat:-7.78818,long:110.431999,code:"JOG"},24600:{lat:-8.74817,long:115.167,code:"DPS"},24700:{lat:-4.8557,long:139.482006,code:"DEX"},24800:{lat:-31.94029998779297,long:115.96700286865234,code:"PER"},24900:{lat:-34.947512,long:138.533393,code:"ADL"},25e3:{lat:-37.673302,long:144.843002,code:"MEL"},25100:{lat:-42.836101532,long:147.509994507,code:"HBA"},25200:{lat:-35.3069,long:149.195007,code:"CBR"},25300:{lat:-33.94609832763672,long:151.177001953125,code:"SYD"},25400:{lat:-27.384199142456055,long:153.11700439453125,code:"BNE"},25500:{lat:-43.48939895629883,long:172.53199768066406,code:"CHC"},25600:{lat:-41.3272018433,long:174.804992676,code:"WLG"},25700:{lat:-37.01199,long:174.786331,code:"AKL"},25800:{lat:-22.014601,long:166.212997,code:"NOU"},25900:{lat:-18.04330062866211,long:178.5590057373047,code:"SUV"},26e3:{lat:-17.553699,long:-149.606995,code:"PPT"},26100:{lat:20.52504,long:-103.301557,code:"GDL"},26200:{lat:20.6173,long:-100.185997,code:"QRO"},26300:{lat:19.435433,long:-99.082432,code:"MEX"},26400:{lat:14.5833,long:-90.527496,code:"GUA"},26500:{lat:14.0609,long:-87.217201,code:"TGU"},26600:{lat:9.99386,long:-84.208801,code:"SJO"},26700:{lat:9.0713596344,long:-79.3834991455,code:"PTY"},26800:{lat:6.16454,long:-75.4231,code:"MDE"},26900:{lat:4.70159,long:-74.1469,code:"BOG"},27e3:{lat:-.125399,long:-78.354306,code:"UIO"},27100:{lat:-2.15742,long:-79.883598,code:"GYE"},27200:{lat:-12.0219,long:-77.114305,code:"LIM"},27300:{lat:-18.348499,long:-70.338699,code:"ARI"},27400:{lat:-33.393001556396484,long:-70.78579711914062,code:"SCL"},27500:{lat:-31.323601,long:-64.208,code:"COR"},27600:{lat:-38.949001,long:-68.155701,code:"NQN"},27700:{lat:-34.8222,long:-58.5358,code:"EZE"},27800:{lat:-25.240156,long:-57.519227,code:"ASU"},27900:{lat:-15.6529,long:-56.116699,code:"CGB"},28e3:{lat:-16.632,long:-49.220699,code:"GYN"},28100:{lat:-15.869167,long:-47.920834,code:"BSB"},28200:{lat:-18.883579,long:-48.225936,code:"UDI"},28300:{lat:-20.817113,long:-49.406963,code:"SJP"},28400:{lat:-21.134314,long:-47.774053,code:"RAO"},28500:{lat:-23.007404,long:-47.134502,code:"VCP"},28600:{lat:-23.478001,long:-47.490002,code:"SOD"},28700:{lat:-23.431944,long:-46.467778,code:"GRU"},28800:{lat:-23.431944,long:-46.467778,code:"QWJ"},28900:{lat:-23.2292,long:-45.8615,code:"SJK"},29e3:{lat:-22.809999,long:-43.250557,code:"GIG"},29100:{lat:-19.63571,long:-43.966928,code:"CNF"},29200:{lat:-21.698299,long:-41.301701,code:"CAW"},29300:{lat:-20.258,long:-40.285,code:"VIX"},29400:{lat:-12.908611,long:-38.322498,code:"SSA"},29500:{lat:-8.125984,long:-34.923316,code:"REC"},29600:{lat:-7.21932,long:-39.269096,code:"JDO"},29700:{lat:-3.775833,long:-38.532222,code:"FOR"},29800:{lat:-1.379279,long:-48.476207,code:"BEL"},29900:{lat:-3.03861,long:-60.049702,code:"MAO"},3e4:{lat:-29.994712,long:-51.166592,code:"POA"},30100:{lat:-27.670279,long:-48.552502,code:"FLN"},30200:{lat:-26.879431,long:-48.650979,code:"ITJ"},30300:{lat:-26.879431,long:-48.650979,code:"NVT"},30400:{lat:-26.831661,long:-49.093569,code:"BNU"},30500:{lat:-26.224501,long:-48.797401,code:"JOI"},30600:{lat:-25.5285,long:-49.1758,code:"CWB"},30700:{lat:-26.787423,long:-50.939942,code:"CFC"},30800:{lat:-27.134199,long:-52.656601,code:"XAP"},30900:{lat:5.45283,long:-55.187801,code:"PBM"},31e3:{lat:6.49855,long:-58.254101,code:"GEO"},31100:{lat:13.0746,long:-59.4925,code:"BGI"},31200:{lat:12.0042,long:-61.786201,code:"GND"},31300:{lat:12.1889,long:-68.959801,code:"CUR"},31400:{lat:18.42970085144,long:-69.668899536133,code:"SDQ"},31500:{lat:19.406099319458008,long:-70.60469818115234,code:"STI"},31600:{lat:17.935699462890625,long:-76.7874984741211,code:"KIN"},31700:{lat:25.79319953918457,long:-80.29060363769531,code:"MIA"},31800:{lat:27.975500106811523,long:-82.533203125,code:"TPA"},31900:{lat:29.6900997162,long:-82.2717971802,code:"GNV"},32e3:{lat:30.49410057067871,long:-81.68789672851562,code:"JAX"},32100:{lat:30.3965,long:-84.350304,code:"TLH"},32200:{lat:32.300598,long:-86.393997,code:"MGM"},32300:{lat:33.6367,long:-84.428101,code:"ATL"},32400:{lat:33.8755989075,long:-84.3020019531,code:"PDK"},32500:{lat:36.1245002746582,long:-86.6781997680664,code:"BNA"},32600:{lat:35.04240036010742,long:-89.97669982910156,code:"MEM"},32700:{lat:38.748697,long:-90.370003,code:"STL"},32800:{lat:39.7173,long:-86.294403,code:"IND"},32900:{lat:41.9786,long:-87.9048,code:"CHI"},33e3:{lat:41.9786,long:-87.9048,code:"ORD"},33100:{lat:42.212398529052734,long:-83.35340118408203,code:"DTW"},33200:{lat:41.411701,long:-81.8498,code:"CLE"},33300:{lat:40.49150085,long:-80.23290253,code:"PIT"},33400:{lat:39.998001,long:-82.891899,code:"CMH"},33500:{lat:39.813801,long:-82.927803,code:"LCK"},33600:{lat:35.2140007019043,long:-80.94309997558594,code:"CLT"},33700:{lat:35.877602,long:-78.787498,code:"RDU"},33800:{lat:36.8946,long:-76.201202,code:"ORF"},33900:{lat:37.50519943237305,long:-77.3197021484375,code:"RIC"},34e3:{lat:38.9445,long:-77.455803,code:"IAD"},34100:{lat:38.8521,long:-77.037697,code:"DCA"},34200:{lat:39.87189865112305,long:-75.24109649658203,code:"PHL"},34300:{lat:40.639447,long:-73.779317,code:"NYC"}},he=document.getElementById("loginModal"),pt=document.getElementById("main-container"),mt=document.getElementById("operators-grid"),ds=document.getElementById("search-input"),cs=document.getElementById("load-more-operators-btn"),ft=document.getElementById("detail-content"),Gt=document.getElementById("operator-detail-view"),qt=document.getElementById("operator-list-view"),lt=document.getElementById("race-view"),dt=document.getElementById("visual-view"),K=document.getElementById("custom-tooltip"),us=document.getElementById("loader-overlay"),ge=document.getElementById("customAlertModal"),q=document.getElementById("wallet-info"),Ct=document.getElementById("data-price-value"),Q=document.getElementById("transactionModal"),yt=document.getElementById("stakeModal"),Et=document.getElementById("settingsModal"),zt=document.getElementById("thegraph-api-key-input"),wt=document.getElementById("tx-modal-amount"),It=document.getElementById("tx-modal-balance-value"),Lt=document.getElementById("tx-modal-minimum-value"),Bt=document.getElementById("stake-modal-amount"),hs=document.getElementById("stake-modal-current-stake"),Jt=document.getElementById("stake-modal-free-funds"),At=document.getElementById("operatorSettingsModal"),Ot=document.getElementById("operator-settings-modal-name"),Nt=document.getElementById("operator-settings-modal-description-input"),Pt=document.getElementById("operator-settings-modal-cut"),$t=document.getElementById("operator-settings-modal-redundancy");let $=null,H=null,et=new Map,J={markers:null,lines:null};function vt(t){us.style.display=t?"flex":"none"}function I(t,e){document.getElementById("customAlertTitle").textContent=t,document.getElementById("customAlertMessage").textContent=e,ge.classList.remove("hidden")}function at(t,e="wallet"){const s=document.getElementById("walletLoginView"),a=document.getElementById("loadingContent"),i=document.getElementById("loading-main-text"),o=document.getElementById("loading-sub-text");t==="loading"?(s.classList.add("hidden"),a.classList.remove("hidden"),i.textContent=e==="guest"?"Loading...":"Fetching operator data, please wait.",o.textContent=e==="guest"?"Fetching operator data, please wait.":"Please follow the instructions in your wallet."):(a.classList.add("hidden"),s.classList.remove("hidden"))}function pe(t){t?(q.innerHTML=`
            <svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            <span>${t.substring(0,6)}...${t.substring(t.length-4)}</span>`,q.className="bg-[#1E1E1E] border border-[#333333] text-white p-3 rounded-lg shadow-lg text-sm flex items-center gap-2"):(q.innerHTML=`
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>`,q.className="bg-[#1E1E1E] border border-[#333333] text-gray-400 hover:text-white p-3 rounded-lg shadow-lg text-sm flex items-center justify-center cursor-pointer transition-colors"),q.classList.remove("hidden")}function Z(t){qt.style.display="none",Gt.style.display="none",lt&&(lt.style.display="none"),dt&&(dt.style.display="none"),t==="list"?qt.style.display="block":t==="race"?lt&&(lt.style.display="block"):t==="visual"?dt&&(dt.style.display="block"):(Gt.style.display="block",window.scrollTo(0,0))}function w(t,e,s={}){const a=document.getElementById(`${t}-input-section`),i=document.getElementById(`${t}-status-section`),o=document.getElementById(`${t}-receipt`),l=document.getElementById(`${t}-close`),n=document.getElementById(`${t}-loader`),r=document.getElementById(`${t}-status-text`),d=document.getElementById(`${t}-status-subtext`),c=document.getElementById(`${t}-amount`),g=document.getElementById(`${t}-receipt-link`),h=document.getElementById(`${t}-receipt-link-2`),p=document.getElementById(`${t}-receipt-text`),f=document.getElementById(`${t}-receipt-text-2`);if(a&&a.classList.add("hidden"),i&&i.classList.add("hidden"),o&&o.classList.add("hidden"),l&&l.classList.add("hidden"),n&&n.classList.remove("hidden"),r&&r.classList.remove("text-red-400"),g&&(g.href="#"),h&&(h.href="#"),p&&(p.textContent="Transaction Successful!"),f&&(f.textContent=""),h&&(h.textContent=""),e==="input"){if(a&&a.classList.remove("hidden"),r&&(r.textContent=""),c&&(c.value=""),t==="operator-settings-modal"){const v=document.getElementById("operator-settings-modal-confirm");v&&(v.disabled=!0,v.textContent="Confirm Changes")}}else e==="loading"?(i&&i.classList.remove("hidden"),r&&(r.textContent=s.text||"Awaiting confirmation..."),d&&(d.textContent=s.subtext||"Please confirm the transaction in your wallet.")):e==="success"?(i&&i.classList.remove("hidden"),o&&o.classList.remove("hidden"),l&&l.classList.remove("hidden"),n&&n.classList.add("hidden"),r&&(r.textContent="Update Successful!"),d&&(d.textContent=""),g&&s.txHash&&(g.href=`https://polygonscan.com/tx/${s.txHash}`,g.textContent="View on Polygonscan"),p&&s.txHash&&(p.textContent=s.tx1Text||"Transaction 1 Successful!"),h&&s.txHash2&&(h.href=`https://polygonscan.com/tx/${s.txHash2}`,h.textContent="View on Polygonscan"),f&&s.txHash2&&(f.textContent=s.tx2Text||"Transaction 2 Successful!")):e==="error"&&(i&&i.classList.remove("hidden"),l&&l.classList.remove("hidden"),n&&n.classList.add("hidden"),r&&(r.textContent="Transaction Failed",r.classList.add("text-red-400")),d&&(d.textContent=s.message||"Something went wrong."))}function me(t){let{name:e,description:s,imageUrl:a}=X(t.metadataJsonString);a&&!a.startsWith("http://")&&!a.startsWith("https://")&&(a=null);const i="https://placehold.co/64x64/1E1E1E/a3a3a3?text=OP",o=Wt(t.stakes),l=B(t.valueWithoutEarnings),n=D(e||t.id),r=Math.round(o*100),d=r===0?"text-red-400":"text-green-400";return`
     <div class="bg-[#1E1E1E] p-5 rounded-xl border border-[#333333] card flex flex-col items-center text-center" data-operator-id="${t.id}">
         <img src="${a||i}" onerror="this.src='${i}'; this.onerror=null;" alt="Operator Avatar" class="w-16 h-16 rounded-full border-2 border-[#333333] object-cover mb-4" ${s?`data-tooltip-content="${D(s)}"`:""}>
         <div class="w-full">
             <h3 class="font-bold text-lg text-white truncate" title="${n}">${n}</h3>
             ${e?`<div class="font-mono text-xs text-gray-500 truncate mt-1">${z(t.id)}</div>`:""}
         </div>
         <div class="mt-4 pt-4 border-t border-[#333333] w-full text-left space-y-2 text-sm">
             <p><strong class="text-gray-400">APY:</strong> <span class="font-mono ${d}">${r}%</span></p>
             <div><strong class="text-gray-400">Total Staked:</strong> <span class="font-mono text-white block" data-tooltip-value="${l}">${O(l)} DATA</span></div>
             <p><strong class="text-gray-400">Delegators:</strong> <span class="font-mono text-white">${t.delegatorCount>0?t.delegatorCount-1:0}</span></p>
         </div>
     </div>`}function gs(t,e){if(!t||t.length===0){let s="No operators found.";e&&e.length>0&&(s=`No operators found for your search "${D(e)}".`),mt.innerHTML=`<p class="text-gray-500 col-span-full">${s}</p>`;return}mt.innerHTML=t.map(me).join("")}function ps(t){t?.length>0&&mt.insertAdjacentHTML("beforeend",t.map(me).join(""))}async function Kt(t){const e=[...new Set(t)];for(const s of e){const i=`${await ze(s)} POL`;document.querySelectorAll(`#agent-balance-${s}, #node-balance-${s}`).forEach(o=>{o&&(o.textContent=i)})}}function Vt(t,e){const s=document.getElementById("delegators-list"),a=document.getElementById("delegators-footer");!s||!a||(s.innerHTML=t.map(i=>`
        <li class="flex justify-between items-center py-2 border-b border-[#333333]">
            <div class="font-mono text-xs text-gray-300 truncate">${z(i.delegator.id)}</div>
            <div class="text-right"><span class="font-mono text-xs text-green-400 block" data-tooltip-value="${B(i._valueDataWei)}">${O(B(i._valueDataWei))} DATA</span></div>
        </li>`).join(""),a.innerHTML="",t.length<e-1&&(a.innerHTML='<button id="load-more-delegators-btn" class="w-full bg-[#2C2C2C] hover:bg-[#3A3A3A] text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center">Load More</button>'))}function fe(t){const e=document.getElementById("sponsorships-history-list");if(e){if(t.length===0){e.innerHTML='<li class="text-gray-500 text-sm p-4 text-center">No recent activity found from The Graph or Polygonscan.</li>';return}e.innerHTML=t.map(s=>{const a=new Date(s.timestamp*1e3).toLocaleString(),i=s.events.filter(r=>r.type==="graph").map(r=>{const d=r.relatedObject;if(!d)return"";const c=`https://streamr.network/hub/network/sponsorships/${d.id}`,g=D(d.stream?.id||d.id);return`
            <div class="flex items-start gap-3 py-2">
                <div class="flex-shrink-0 pt-1"><svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg></div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm text-gray-300 truncate">${`Action on ${`<a href="${c}" target="_blank" rel="noopener noreferrer" class="text-gray-300 hover:text-white transition-colors" title="${g}">${g}</a>`}`}</p>
                </div>
                <div class="text-right flex-shrink-0">
                    <p class="font-mono text-sm text-white" ${r.token.toUpperCase()==="DATA"?`data-tooltip-value="${Math.round(r.amount)}"`:""}>${O(Math.round(r.amount).toString())} ${D(r.token)}</p>
                </div>
            </div>`}).join(""),o=s.events.filter(r=>r.type==="scan").map(r=>{let d;const c=r.methodId;["Stake","Unstake","Force Unstake"].includes(c)?d="tx-badge-stake":r.relatedObject==="OUT"?d="tx-badge-out":d="tx-badge-in";const h=`https://polygonscan.com/tx/${r.txHash}`;return`
            <div class="flex items-center gap-3 py-2">
                <div class="flex-shrink-0">
                    <span class="tx-badge ${d}">${r.relatedObject}</span>
                </div>
                <div class="flex-1 min-w-0">
                    <a href="${h}" target="_blank" rel="noopener noreferrer" class="text-sm font-medium text-gray-300 hover:text-white truncate transition-colors block">
                        ${D(r.methodId)}
                    </a>
                </div>
                <div class="text-right flex-shrink-0">
                    <p class="font-mono text-sm text-white" ${r.token.toUpperCase()==="DATA"?`data-tooltip-value="${Math.round(r.amount)}"`:""}>${O(Math.round(r.amount).toString())} ${D(r.token)}</p>
                </div>
            </div>`}).join(""),l=i.length>0,n=o.length>0;return`
        <li class="py-3 border-b border-[#333333]">
            <p class="text-xs text-gray-400 font-mono mb-2">${a}</p>
            <div>
                ${l?`
                    <div>
                        <h4 class="text-sm font-semibold text-white mb-1">Sponsorship Actions</h4>
                        <div class="pl-4 border-l-2 border-gray-700">${i}</div>
                    </div>
                `:""}
                
                ${n?`
                    <div class="${l?"mt-2":""}">
                         <div class="pl-4">${o}</div>
                    </div>
                `:""}
            </div>
        </li>`}).join("")}}function ms(t,e){const s=document.getElementById("stake-chart-container");if(!s)return;if(!t||t.length===0){$&&($.destroy(),$=null),s.innerHTML='<div class="flex items-center justify-center h-full"><p class="text-gray-500">No daily data available for this timeframe.</p></div>';return}const a=t.map(c=>c.label),i=t.map(c=>c.value),o=e?"Total Stake (USD)":"Total Stake (DATA)",l=e?"$":"",n=e?"":" DATA",r=c=>{const g=c.createLinearGradient(0,0,0,300);return g.addColorStop(0,"rgba(59, 130, 246, 0.5)"),g.addColorStop(1,"rgba(59, 130, 246, 0.0)"),g},d={responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!1},tooltip:{backgroundColor:"rgba(30, 30, 30, 0.9)",titleColor:"#ffffff",bodyColor:"#9ca3af",borderColor:"#333333",borderWidth:1,padding:10,cornerRadius:8,displayColors:!1,titleFont:{family:"'Inter', sans-serif",size:13,weight:"600"},bodyFont:{family:"'Inter', sans-serif",size:12},callbacks:{label:function(c){let g="";return c.parsed.y!==null&&(g+=l+O(Math.round(c.parsed.y).toString())+n),g}}}},scales:{x:{ticks:{color:"#6b7280",maxTicksLimit:8,maxRotation:0,autoSkip:!0,font:{family:"'Inter', sans-serif",size:11}},grid:{display:!1}},y:{position:"left",ticks:{color:"#6b7280",callback:function(c){return c>=1e6?l+(c/1e6).toFixed(1)+"M":c>=1e3?l+(c/1e3).toFixed(0)+"K":l+Math.round(c)},font:{family:"'Inter', sans-serif",size:11}},grid:{color:"#333333",borderDash:[4,4],drawBorder:!1}}}};if($)$.data.labels=a,$.data.datasets[0].data=i,$.data.datasets[0].label=o,$.options.scales.y.ticks.callback=d.scales.y.ticks.callback,$.options.plugins.tooltip.callbacks.label=d.plugins.tooltip.callbacks.label,$.update();else{s.innerHTML='<canvas id="stake-history-chart"></canvas>';const c=document.getElementById("stake-history-chart");if(!c)return;const g=c.getContext("2d");if(!g)return;$=new Chart(g,{type:"line",data:{labels:a,datasets:[{label:o,data:i,backgroundColor:r(g),borderColor:"#3b82f6",borderWidth:2,pointBackgroundColor:"#3b82f6",pointBorderColor:"#1E1E1E",pointBorderWidth:1,pointRadius:2.5,pointHoverRadius:4,tension:.15,fill:!0}]},options:d})}}function fs(t){const{name:e,description:s}=X(t.metadataJsonString);let a="1";try{if(t.metadataJsonString){const o=JSON.parse(t.metadataJsonString);o&&o.redundancyFactor!==void 0&&(a=o.redundancyFactor)}}catch{}const i=BigInt(t.operatorsCutFraction)*100n/BigInt("1000000000000000000");Ot.value=e||"",Nt.value=s||"",Pt.value=i.toString(),$t.value=a,document.getElementById("operator-settings-modal-confirm").disabled=!1,At.classList.remove("hidden")}function ys(t,e){$&&($.destroy(),$=null);const{operator:s,selfDelegation:a,flagsAgainst:i,flagsAsFlagger:o,slashingEvents:l}=t;if(!s){ft.innerHTML='<p class="text-gray-500">Operator not found.</p>';return}let{name:n,description:r,imageUrl:d}=X(s.metadataJsonString);d&&!d.startsWith("http://")&&!d.startsWith("https://")&&(d=null);const c=D(n||s.id),g="https://placehold.co/80x80/1E1E1E/a3a3a3?text=OP";let h="1 (Default)";try{if(s.metadataJsonString){const y=JSON.parse(s.metadataJsonString);y&&y.redundancyFactor!==void 0&&(h=y.redundancyFactor)}}catch(y){console.error("Could not parse redundancy factor from metadata",y)}const p=Wt(s.stakes);BigInt(s.operatorsCutFraction)*100n/BigInt("1000000000000000000");const v=e.myRealAddress&&s.owner&&e.myRealAddress.toLowerCase()===s.owner.toLowerCase()?`
        <div class="mb-4">
            <button id="edit-operator-settings-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                Edit Settings
            </button>
        </div>
    `:"",x=`
        <div class="detail-section px-6 pt-6 pb-2">
            <div class="flex items-center gap-6">
                <img src="${d||g}" onerror="this.src='${g}';" alt="Operator Avatar" class="w-20 h-20 rounded-full border-2 border-[#333333] flex-shrink-0 object-cover" ${r?`data-tooltip-content="${D(r)}"`:""}>
                <div class="flex-1 min-w-0">
                    <div class="flex items-start md:items-center justify-between flex-col md:flex-row gap-4">
                        <div class="min-w-0">
                            <h2 class="text-3xl font-bold text-white break-words" ${r?`data-tooltip-content="${D(r)}"`:""}>${c}</h2>
                            ${n?`<div class="font-mono text-sm text-gray-400 mt-1 break-words">${z(s.id)}</div>`:""}
                        </div>
                        <div class="flex-shrink-0 text-right"><p class="text-sm text-gray-400 font-semibold mb-1">APY</p><p class="text-4xl font-extrabold text-green-400 whitespace-nowrap mb-4">${Math.round(p*100)}%</p></div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mt-6">
                <div><p class="text-sm text-gray-400">Stake (DATA)</p><p id="header-stat-stake" class="text-2xl font-semibold text-white"></p></div>
                <div><p class="text-sm text-gray-400">Total Earnings (DATA)</p><p id="header-stat-earnings" class="text-2xl font-semibold text-white"></p></div>
                <div><p class="text-sm text-gray-400">% Owner's Cut</p><p id="header-stat-cut" class="text-2xl font-semibold text-white"></p></div>
                <div><p class="text-sm text-gray-400">Nodes</p><p id="active-nodes-stats-value" class="text-2xl font-semibold text-white">0</p></div>
            </div>
            <div id="extended-stats" class="hidden mt-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    <div><p class="text-sm text-gray-400">Total Distributed (DATA)</p><p id="extended-stat-distributed" class="text-2xl font-semibold text-white"></p></div>
                    <div><p class="text-sm text-gray-400">Owner's Earnings from Cut (DATA)</p><p id="extended-stat-owner-cut" class="text-2xl font-semibold text-white"></p></div>
                    <div><p class="text-sm text-gray-400">Deployed Stake (DATA)</p><p id="extended-stat-deployed" class="text-2xl font-semibold text-white"></p></div>
                    <div><p class="text-sm text-gray-400">% Owner's Stake</p><p id="extended-stat-owner-stake" class="text-2xl font-semibold text-white"></p></div>
                </div>
            </div>
            <div class="mt-4 text-center"><button id="toggle-stats-btn" class="text-gray-400 hover:text-white transition"><svg id="stats-arrow" class="w-6 h-6 mx-auto transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 9l-7 7-7-7"></path></svg></button></div>
        </div>
        
        <div class="detail-section p-6 mt-8">
            <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                <div class="flex items-center gap-4">
                     <h3 class="text-xl font-semibold text-white">Stake</h3>
                     <div id="chart-view-buttons" class="flex items-center gap-1 bg-[#2C2C2C] p-1 rounded-lg">
                        <button data-view="data" class="px-3 py-1 text-xs font-bold rounded-md hover:bg-[#444444] transition">DATA</button>
                        <button data-view="usd" class="px-3 py-1 text-xs font-bold rounded-md hover:bg-[#444444] transition">USD</button>
                    </div>
                </div>
                <div id="chart-timeframe-buttons" class="flex items-center gap-1 bg-[#2C2C2C] p-1 rounded-lg">
                    <button data-days="30" class="px-3 py-1 text-xs font-bold rounded-md hover:bg-[#444444] transition">30D</button>
                    <button data-days="90" class="px-3 py-1 text-xs font-bold rounded-md hover:bg-[#444444] transition">90D</button>
                    <button data-days="365" class="px-3 py-1 text-xs font-bold rounded-md hover:bg-[#444444] transition">1Y</button>
                    <button data-days="all" class="px-3 py-1 text-xs font-bold rounded-md hover:bg-[#444444] transition">All</button>
                </div>
            </div>
            <div id="stake-chart-container" class="h-64">
                <canvas id="stake-history-chart"></canvas>
            </div>
        </div>

        <div id="my-stake-section" class="detail-section p-6 hidden">
             <h3 class="text-xl font-semibold text-white mb-4">Your Stake</h3>
             <div class="flex items-center justify-between">
                 <div><p class="text-3xl font-semibold text-white" id="my-stake-value" data-tooltip-value="0">Loading...</p></div>
                 <div class="flex gap-4">
                     <button id="delegate-btn" class="bg-blue-800 hover:bg-blue-900 text-white font-bold py-2 px-6 rounded-lg transition-colors">Delegate</button>
                     <button id="undelegate-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Undelegate</button>
                 </div>
             </div>
        </div>`,m=e.myRealAddress&&s.controllers?.some(y=>y.toLowerCase()===e.myRealAddress.toLowerCase()),E=s.stakes?.length>0?s.stakes.map(y=>{const b=y.sponsorship;if(!b)return"";const U=`https://streamr.network/hub/network/sponsorships/${b.id}`,F=D(b.stream?.id||b.id),j=m?`<a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-[#444444] edit-stake-link" data-sponsorship-id="${b.id}" data-current-stake="${y.amountWei}">Edit Stake</a>`:'<span class="block px-4 py-2 text-sm text-gray-500 opacity-50 cursor-not-allowed" data-tooltip-content="You must be an agent for this operator to edit stake.">Edit Stake</span>';return`
            <li class="relative flex justify-between items-center py-3 border-b border-[#333333]">
                <div class="flex-1 min-w-0">
                    <a href="${U}" target="_blank" rel="noopener noreferrer" class="font-mono text-xs text-gray-300 hover:text-white transition-colors truncate block" title="${F}">${F}</a>
                    <div class="text-xs mt-2 space-y-1">
                        <div class="flex justify-between items-center"><span class="text-gray-400">Staked:</span><strong class="text-white font-mono" data-tooltip-value="${B(y.amountWei)}">${O(B(y.amountWei))} DATA</strong></div>
                        <div class="flex justify-between items-center"><span class="text-gray-400">APY:</span><strong class="text-green-400 font-mono">${Math.round(Number(b.spotAPY)*100)}%</strong></div>
                        <div class="flex justify-between items-center"><span class="text-gray-400">Status:</span><strong class="${b.isRunning?"text-green-400":"text-red-400"} font-semibold">${b.isRunning?"Active":"Inactive"}</strong></div>
                    </div>
                </div>
                <div class="flex-shrink-0 ml-4">
                        <button class="text-gray-400 hover:text-white p-1 toggle-sponsorship-menu-btn" data-sponsorship-id="${b.id}"><svg class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M7 10l5 5 5-5H7z"/></svg></button>
                    <div id="sponsorship-menu-${b.id}" class="hidden absolute right-0 w-48 bg-[#2C2C2C] border border-[#333333] rounded-md shadow-lg z-20">
                        ${j}
                        <a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-[#444444] collect-earnings-link" data-sponsorship-id="${b.id}">Collect Earnings</a>
                    </div>
                </div>
            </li>`}).join(""):'<li class="text-gray-500 text-sm">Not participating in any sponsorships.</li>',A=l.length>0?l.map(y=>{const b=y.sponsorship;let U='<p class="text-xs text-gray-400">Sponsorship: Unknown</p>';if(b){const F=`https://streamr.network/hub/network/sponsorships/${b.id}`,j=D(b.stream?.id||b.id);U=`<p class="text-xs text-gray-400 truncate">Sponsorship: <a href="${F}" target="_blank" rel="noopener noreferrer" class="text-gray-300 hover:text-white transition-colors" title="${j}">${j}</a></p>`}return`
            <li class="py-2 border-b border-[#333333]">
                <p class="font-mono text-xs text-red-400 font-semibold" data-tooltip-value="${B(y.amount)}">${O(B(y.amount))} DATA</p>
                <div class="text-xs mt-1 text-gray-400">
                    <p>Date: ${new Date(y.date*1e3).toLocaleDateString()}</p>
                    ${U}
                </div>
            </li>`}).join(""):'<li class="text-gray-500 text-sm">No slashing events recorded.</li>',C=s.controllers?.length>0?s.controllers.map(y=>`
        <li class="flex justify-between items-center py-2 border-b border-[#333333]">
            <div class="font-mono text-xs text-gray-300 truncate">${z(y)}</div>
            <div class="flex items-center gap-2">
                <span id="agent-balance-${y}" class="font-mono text-xs text-gray-300 text-right" title="POL Balance">...</span>
                ${s.owner&&y.toLowerCase()===s.owner.toLowerCase()?'<div class="flex items-center" title="Owner"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg></div>':""}
            </div>
        </li>`).join(""):'<li class="text-gray-500 text-sm">No agents assigned.</li>',S=s.nodes?.length>0?s.nodes.map(y=>`
        <li class="flex justify-between items-center py-2 border-b border-[#333333]">
            <div class="font-mono text-xs text-gray-300 truncate">${z(y)}</div>
            <span id="node-balance-${y}" class="font-mono text-xs text-gray-300 text-right" title="POL Balance">...</span>
        </li>`).join(""):'<li class="text-gray-500 text-sm">No nodes running.</li>',T=s.queueEntries?.length>0?s.queueEntries.map(y=>`
            <li class="py-2 border-b border-[#333333]">
            <div class="flex justify-between items-center">
                <div class="font-mono text-xs text-gray-300 truncate">${z(y.delegator.id)}</div>
                <p class="font-mono text-xs text-orange-400 font-semibold" data-tooltip-value="${B(y.amount)}">${O(B(y.amount))} DATA</p>
            </div>
            <div class="text-xs mt-1 text-gray-400"><p>Queued: ${new Date(y.date*1e3).toLocaleString()}</p></div>
        </li>`).join(""):'<li class="text-gray-500 text-sm">The undelegation queue is empty.</li>',k=(y,b)=>{const U=`https://streamr.network/hub/network/sponsorships/${y.sponsorship.id}`,F=D(y.sponsorship.stream?.id||y.sponsorship.id),j=y.votes.map(tt=>`
            <li class="flex justify-between items-center text-xs py-1">
                <span>${ht(tt.voter)}</span>
                <div class="flex items-center gap-2">
                    <span class="font-mono" data-tooltip-value="${B(tt.voterWeight)}">${O(B(tt.voterWeight))}</span>
                    <span class="${tt.votedKick?"text-red-400":"text-green-400"} font-semibold">${tt.votedKick?"Kick":"Keep"}</span>
                </div>
            </li>
        `).join("");let it=y.result||"Pending";(it.toUpperCase()==="FAILED"||it.toUpperCase()==="VOTE_FAILED")&&(it="False Flag");const Ie=b?`Flagged by: ${ht(y.flagger)}`:`Flagged: ${ht(y.target)}`;return`
            <div class="flex justify-between items-center">
                <div>
				    <p class="text-xs text-gray-400 font-mono mb-1">${new Date(y.flaggingTimestamp*1e3).toLocaleString()}</p>
                    <p class="text-xs text-gray-400">${Ie}</p>
                    <p class="text-xs text-gray-400 truncate">Sponsorship: <a href="${U}" target="_blank" rel="noopener noreferrer" class="text-gray-300 hover:text-white transition-colors" title="${F}">${F}</a></p>
                        <p class="text-xs text-gray-400">Result: <span class="font-semibold">${it}</span></p>
                </div>
                <button class="text-gray-400 hover:text-white p-1 toggle-vote-list-btn" data-flag-id="${y.id}"><svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg></button>
            </div>
            <ul id="votes-${y.id}" class="hidden mt-2 pl-4 border-l-2 border-gray-700">${j||'<li class="text-xs text-gray-500">No votes.</li>'}</ul>`},N=i?.length>0?i.map(y=>`<li class="py-2 border-b border-[#333333]">${k(y,!0)}</li>`).join(""):'<li class="text-gray-500 text-sm">No flags recorded against this operator.</li>',M=o?.length>0?o.map(y=>`<li class="py-2 border-b border-[#333333]">${k(y,!1)}</li>`).join(""):'<li class="text-gray-500 text-sm">This operator has not flagged anyone.</li>',R=`
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
            <div class="detail-section p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="delegator-queue-title" class="text-xl font-semibold text-white">Delegators</h3>
                    <button id="toggle-delegator-view-btn" title="Switch View" class="text-gray-400 hover:text-white p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M5 7h14" />
                        </svg>
                    </button>
                </div>
                <div id="delegators-content"><ul id="delegators-list" class="max-h-96 overflow-y-auto pr-2"></ul><div id="delegators-footer" class="mt-4"></div></div>
                <div id="queue-content" class="hidden">
                    ${s.queueEntries?.length>0?'<button id="process-queue-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg text-sm mb-4">Process Queue</button>':""}
                    <ul class="max-h-96 overflow-y-auto pr-2">${T}</ul>
                </div>
            </div>
            <div class="detail-section p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="sponsorships-title" class="text-xl font-semibold text-white">Sponsorships (${s.stakes?.length||0})</h3>
                    <div class="flex items-center gap-2">
                        <button id="toggle-sponsorship-view-btn" title="Switch View" class="text-gray-400 hover:text-white p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M5 7h14" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="sponsorships-list-content">
                    <ul class="max-h-96 overflow-y-auto pr-2">${E}</ul>
                    <div class="mt-4">
                        ${s.stakes?.length>0?'<button id="collect-all-earnings-btn" class="w-full bg-blue-800 hover:bg-blue-900 text-white font-bold py-2 px-4 rounded-lg text-sm">Collect All</button>':""}
                    </div>
                </div>
                <div id="sponsorships-history-content" class="hidden">
                    <ul id="sponsorships-history-list" class="max-h-96 overflow-y-auto pr-2"></ul>
                </div>
            </div>
            <div class="detail-section p-6 lg:col-span-2">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="reputation-title" class="text-xl font-semibold text-white">Slashing Events</h3>
                    <button id="toggle-reputation-view-btn" title="Switch View" class="text-gray-400 hover:text-white p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M5 7h14" />
                        </svg>
                    </button>
                </div>
                <div id="reputation-content-wrapper" 
                    data-slashes-count="${l.length}" 
                    data-flags-against-count="${i?.length||0}" 
                    data-flags-by-count="${o?.length||0}">
                    <div id="slashing-content"><ul class="max-h-96 overflow-y-auto pr-2">${A}</ul></div>
                    <div id="flags-against-content" class="hidden"><ul class="max-h-96 overflow-y-auto pr-2">${N}</ul></div>
                    <div id="flags-by-content" class="hidden"><ul class="max-h-96 overflow-y-auto pr-2">${M}</ul></div>
                </div>
            </div>
            <div class="detail-section p-6 lg:col-span-2">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="wallets-title" class="text-xl font-semibold text-white">Agents</h3>
                    <button id="toggle-wallets-view-btn" title="Switch View" class="text-gray-400 hover:text-white p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M5 7h14" />
                        </svg>
                    </button>
                </div>
                <div id="agents-content" data-agents-count="${s.controllers?.length||0}"><ul class="max-h-96 overflow-y-auto pr-2">${C}</ul></div>
                <div id="nodes-content" class="hidden" data-nodes-count="${s.nodes?.length||0}"><ul class="max-h-96 overflow-y-auto pr-2">${S}</ul></div>
            </div>
        </div>`,P=`
        <div class="detail-section p-6 mt-8">
            <div class="flex items-center justify-between mb-4 flex-wrap gap-y-2">
                <h3 class="text-xl font-semibold text-white">Coordination Stream</h3>
                <div class="flex items-center gap-2 text-sm">
                    <div class="flex items-center gap-2" title="Awaiting connection..."><div id="stream-status-indicator" class="w-3 h-3 rounded-full bg-gray-500"></div></div>
                    <div class="bg-[#2C2C2C] text-gray-200 font-semibold px-3 py-1 rounded-lg">Active Nodes: <span id="active-nodes-count-value" class="text-white font-bold">0</span></div>
                    <div id="unreachable-nodes-container" class="hidden bg-[#2C2C2C] text-gray-200 font-semibold px-3 py-1 rounded-lg" title="Nodes that are active but may not be reachable by all peers.">Unreachable: <span id="unreachable-nodes-count-value" class="text-orange-400 font-bold">0</span></div>
                    <div class="bg-[#2C2C2C] text-gray-200 font-semibold px-3 py-1 rounded-lg">Redundancy: <span class="text-white font-bold">${D(String(h))}</span></div>
                </div>
            </div>
            <div id="stream-messages-container" class="max-h-96 overflow-y-auto pr-2 bg-black/50 p-2"><div class="text-gray-500 text-sm text-center py-4">Live messages will appear here.</div></div>
        </div>
        
        <!-- Node Map -->
        <div class="detail-section p-6 mt-8">
            <div id="node-map-container" class="h-96 w-full rounded-lg bg-black/50" style="z-index: 0;">
                <div class="text-gray-500 text-sm text-center py-4">Initializing map...</div>
            </div>
        </div>
        `;ft.innerHTML=v+x+R+P,ye(t),Vt(e.currentDelegations,e.totalDelegatorCount),ve(!0,e.uiState),e.uiState.isDelegatorViewActive||xe(s,e.uiState),be(!0,e.uiState),we(!0,e.uiState),Se(e.uiState,s,!0),Ss("node-map-container")}function ye(t,e){const{operator:s,selfDelegation:a}=t;if(!s)return;const i=a?.[0],o=BigInt(s.valueWithoutEarnings),l=BigInt(s.cumulativeEarningsWei),n=BigInt(s.cumulativeOperatorsCutWei),r=i?BigInt(i._valueDataWei):0n,d=l-n,c=BigInt(s.operatorsCutFraction)*100n/BigInt("1000000000000000000"),g=o>0n?Number(r*10000n/o)/100:0,h=s.stakes?.reduce((R,P)=>R+BigInt(P.amountWei),0n)||0n,p=B(s.valueWithoutEarnings),f=B(s.cumulativeEarningsWei),v=B(s.cumulativeOperatorsCutWei),x=B(d.toString()),m=B(h.toString()),E=B(r.toString()),A=document.getElementById("header-stat-stake");A&&(A.textContent=O(p),A.setAttribute("data-tooltip-value",p));const C=document.getElementById("header-stat-earnings");C&&(C.textContent=O(f),C.setAttribute("data-tooltip-value",f));const S=document.getElementById("header-stat-cut");S&&(S.textContent=`${c}%`);const T=document.getElementById("extended-stat-distributed");T&&(T.textContent=O(x),T.setAttribute("data-tooltip-value",x));const k=document.getElementById("extended-stat-owner-cut");k&&(k.textContent=O(v),k.setAttribute("data-tooltip-value",v));const N=document.getElementById("extended-stat-deployed");N&&(N.textContent=O(m),N.setAttribute("data-tooltip-value",m));const M=document.getElementById("extended-stat-owner-stake");M&&(M.textContent=`${Math.round(g)}%`,M.setAttribute("data-tooltip-content",`${O(E)} DATA`))}function ve(t,e){t||(e.isStatsPanelExpanded=!e.isStatsPanelExpanded);const s=document.getElementById("extended-stats"),a=document.getElementById("stats-arrow");s&&a&&(e.isStatsPanelExpanded?(s.classList.remove("hidden"),a.classList.add("rotate-180")):(s.classList.add("hidden"),a.classList.remove("rotate-180")))}function xe(t,e){e.isDelegatorViewActive=!e.isDelegatorViewActive;const s=document.getElementById("delegators-content"),a=document.getElementById("queue-content"),i=document.getElementById("delegator-queue-title");t&&(s.classList.toggle("hidden"),a.classList.toggle("hidden"),i.textContent=e.isDelegatorViewActive?`Delegators (${t.delegatorCount>0?t.delegatorCount-1:0})`:`Undelegation Queue (${t.queueEntries?.length||0})`)}function vs(t){document.getElementById(`votes-${t}`)?.classList.toggle("hidden")}function be(t,e){t||(e.reputationViewIndex=(e.reputationViewIndex+1)%3);const s=document.getElementById("reputation-content-wrapper");if(!s)return;const a=document.getElementById("reputation-title"),{slashesCount:i,flagsAgainstCount:o,flagsByCount:l}=s.dataset;Object.values(s.children).forEach(n=>n.classList.add("hidden")),e.reputationViewIndex===0?(a.textContent=`Slashing Events (${i})`,s.children[0].classList.remove("hidden")):e.reputationViewIndex===1?(a.textContent=`Flags Against Operator (${o})`,s.children[1].classList.remove("hidden")):(a.textContent=`Flags Initiated by Operator (${l})`,s.children[2].classList.remove("hidden"))}function we(t,e){t||(e.walletViewIndex=(e.walletViewIndex+1)%2);const s=document.getElementById("agents-content"),a=document.getElementById("nodes-content");if(!s||!a)return;const i=document.getElementById("wallets-title"),{agentsCount:o}=s.dataset,{nodesCount:l}=a.dataset;s.classList.add("hidden"),a.classList.add("hidden"),e.walletViewIndex===0?(i.textContent=`Agents (${o})`,s.classList.remove("hidden")):(i.textContent=`Node Wallets (${l})`,a.classList.remove("hidden"))}function Se(t,e,s=!1){s||(t.isSponsorshipsListViewActive=!t.isSponsorshipsListViewActive);const a=document.getElementById("sponsorships-list-content"),i=document.getElementById("sponsorships-history-content"),o=document.getElementById("sponsorships-title");!a||!i||!o||!e||(a.classList.toggle("hidden",!t.isSponsorshipsListViewActive),i.classList.toggle("hidden",t.isSponsorshipsListViewActive),o.textContent=t.isSponsorshipsListViewActive?`Sponsorships (${e.stakes?.length||0})`:"History")}function xs(t,e){document.querySelectorAll("#chart-timeframe-buttons button").forEach(i=>{i.dataset.days===String(t)?(i.classList.add("bg-blue-800","text-white"),i.classList.remove("hover:bg-[#444444]")):(i.classList.remove("bg-blue-800","text-white"),i.classList.add("hover:bg-[#444444]"))}),document.querySelectorAll("#chart-view-buttons button").forEach(i=>{i.dataset.view==="usd"&&e||i.dataset.view==="data"&&!e?(i.classList.add("bg-blue-800","text-white"),i.classList.remove("hover:bg-[#444444]")):(i.classList.remove("bg-blue-800","text-white"),i.classList.add("hover:bg-[#444444]"))})}function bs(t,e,s){const a=document.getElementById("stream-messages-container");if(!a)return;if(t?.msgType==="heartbeat"&&t?.peerDescriptor?.nodeId){const l=t.peerDescriptor.nodeId,n=t.peerDescriptor.region,r=t.peerDescriptor.websocket?.host||l;if(!e.has(l)&&(e.add(l),document.getElementById("active-nodes-count-value").textContent=e.size,document.getElementById("active-nodes-stats-value").textContent=e.size,n&&H)){const d=ls[n];d?Cs(d,r,l):console.warn(`Region code ${n} not found in location map.`)}if(t.peerDescriptor?.websocket?.tls===!1&&!s.has(l)){s.add(l);const d=document.getElementById("unreachable-nodes-container");d.querySelector("span").textContent=s.size,d.classList.remove("hidden")}}const i=a.querySelector(".text-gray-500");i&&i.remove();const o=document.createElement("div");for(o.className="stream-message-entry py-2 border-t border-[#333333]/50 first:border-t-0",o.innerHTML=`
        <div class="flex justify-between items-center text-xs text-gray-400 mb-1">
            <span class="font-mono">${new Date().toLocaleTimeString()}</span>
        </div>
        <pre class="whitespace-pre-wrap break-all text-xs text-gray-400"><code>${D(JSON.stringify(t,null,2))}</code></pre>`,a.prepend(o);a.children.length>20;)a.removeChild(a.lastChild)}function ws(){H&&(H.remove(),H=null),et.clear(),J={markers:null,lines:null}}function Ss(t){ws();try{const e=document.getElementById(t);if(!e){console.error("Map container not found:",t);return}e.innerHTML="",H=L.map(t,{zoomControl:!0,attributionControl:!1}).setView([20,0],2),L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',subdomains:"abcd",maxZoom:19,minZoom:2}).addTo(H),setTimeout(()=>{H&&H.invalidateSize()},0),J.lines=L.layerGroup().addTo(H),J.markers=L.layerGroup().addTo(H)}catch(e){console.error("Failed to initialize Leaflet map:",e);const s=document.getElementById(t);s&&(s.innerHTML='<p class="text-red-400">Error loading map.</p>')}}function Yt(t){const e=[];for(const[s,a]of t.entries()){const i=D(a),o=D(s);e.push(`- host: ${i}
  node: ${o}`)}return`<pre style="margin: 0; font-family: monospace; font-size: 10px;">${e.join(`

`)}</pre>`}function Cs(t,e,s){if(!H||!J.markers||!J.lines)return;const a=[t.lat,t.long],i=`${t.lat},${t.long}`;if(et.has(i)){const o=et.get(i);o.nodes.set(s,e);const l=Yt(o.nodes);o.marker.setTooltipContent(l)}else{const o=L.circleMarker(a,{radius:5,fillColor:"#3b82f6",color:"#FFFFFF",weight:1,opacity:1,fillOpacity:.8}).addTo(J.markers),l=new Map;l.set(s,e),o.bindTooltip(Yt(l)),et.set(i,{marker:o,nodes:l,location:t});for(const[n,r]of et.entries())if(n!==i){const d=[[r.location.lat,r.location.long],a];L.polyline(d,{color:"rgba(255, 255, 255, 0.4)",weight:1}).addTo(J.lines)}}}const Es="bb77dd994c8e90edcbd73661a326f068",Is="EGWFdhhiWypDuz22Uy7b3F69E9MEkyfU9iAQMttkH5Rj",kt=`https://gateway.thegraph.com/api/${Es}/subgraphs/id/${Is}`,Ls="2023-11-25T00:00:00Z",Qt=Math.floor(new Date(Ls).getTime()/1e3),Mt=50,ks=15,Xt=18,Zt=["bg-red-600","bg-orange-500","bg-yellow-400","bg-lime-600","bg-green-600","bg-emerald-500","bg-teal-600","bg-cyan-500","bg-sky-600","bg-blue-600","bg-indigo-600","bg-purple-600","bg-fuchsia-600","bg-pink-500","bg-rose-600","bg-amber-500","bg-slate-600","bg-stone-600"],Ms=t=>t?(parseFloat(t)/1e18).toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0}).replace(/,/g," "):"0",Ts=(t,e)=>{const s=`Operator ${e.slice(0,6)}`;try{return t?{name:JSON.parse(t).name||s}:{name:s}}catch{return{name:s}}},Ds=t=>new Date(t*1e3).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}).replace(",",""),Bs=t=>{if(t===0)return 1e3;const e=t/16,s=Math.pow(10,Math.floor(Math.log10(e))),a=e/s;let i;return a<1.5?i=1:a<3?i=2:a<7?i=5:i=10,i*s},Ce={state:{timelineData:[],operatorMetaMap:{},rawBuckets:[],allOperatorIds:[],filterDeprecated:!1,currentIndex:0,isPlaying:!1,playbackSpeed:100,activeMetric:"stake",timer:null,domElements:new Map,hasInitialized:!1},els:{},init:async function(){this.state.hasInitialized||(this.els={loadingState:document.getElementById("loading-state"),loadingBar:document.getElementById("loading-bar"),loadingText:document.getElementById("loading-text"),loadingMini:document.getElementById("loading-mini"),errorState:document.getElementById("error-state"),errorMsg:document.getElementById("error-msg"),chartArea:document.getElementById("chart-area"),barsContainer:document.getElementById("bars-container"),bgYearDisplay:document.getElementById("bg-year-display"),bgDayDisplay:document.getElementById("bg-day-display"),lblCurrentDate:document.getElementById("lbl-current-date"),slider:document.getElementById("timeline-slider"),btnPlay:document.getElementById("btn-play"),btnSpeed:document.getElementById("btn-speed"),btnMetricStake:document.getElementById("btn-metric-stake"),btnMetricEarnings:document.getElementById("btn-metric-earnings"),toggleFilter:document.getElementById("toggle-filter"),btnTryAgain:document.getElementById("btn-try-again")},this.els.btnPlay&&this.els.btnPlay.addEventListener("click",()=>this.togglePlay()),this.els.btnSpeed&&this.els.btnSpeed.addEventListener("click",()=>this.toggleSpeed()),this.els.toggleFilter&&this.els.toggleFilter.addEventListener("change",()=>this.toggleFilter()),this.els.slider&&this.els.slider.addEventListener("input",t=>{this.state.isPlaying=!1,this.updatePlayButton(),this.state.currentIndex=parseInt(t.target.value),this.renderFrame(this.state.currentIndex)}),this.els.btnMetricStake&&this.els.btnMetricStake.addEventListener("click",()=>this.setMetric("stake")),this.els.btnMetricEarnings&&this.els.btnMetricEarnings.addEventListener("click",()=>this.setMetric("earnings")),this.els.btnTryAgain&&this.els.btnTryAgain.addEventListener("click",()=>this.init()),this.state.hasInitialized=!0),this.resetUI();try{await this.fetchData()}catch(t){console.error(t),this.els.loadingState&&this.els.loadingState.classList.add("hidden"),this.els.errorMsg&&(this.els.errorMsg.textContent=t.message||"Error loading data"),this.els.errorState&&this.els.errorState.classList.remove("hidden")}},stop:function(){this.state.isPlaying=!1,this.state.timer&&(clearTimeout(this.state.timer),this.state.timer=null),this.updatePlayButton()},resetUI:function(){this.els.errorState&&this.els.errorState.classList.add("hidden"),this.els.chartArea&&this.els.chartArea.classList.add("hidden"),this.els.loadingState&&this.els.loadingState.classList.remove("hidden"),this.els.loadingBar&&(this.els.loadingBar.style.width="0%"),this.els.loadingText&&(this.els.loadingText.textContent="Discovering operators..."),this.state.currentIndex=0,this.state.isPlaying=!1,this.state.timelineData=[],this.state.domElements.clear(),this.els.barsContainer&&(this.els.barsContainer.innerHTML="",this.els.barsContainer.style.height=`${Mt*Xt+40}px`),this.updatePlayButton()},setMetric:function(t){this.state.activeMetric=t;const e=this.els.slider;t==="stake"?(this.els.btnMetricStake.classList.add("active"),this.els.btnMetricStake.classList.remove("earnings-mode"),this.els.btnMetricEarnings.classList.remove("active","earnings-mode"),e&&(e.style.accentColor="#2563eb")):(this.els.btnMetricStake.classList.remove("active"),this.els.btnMetricEarnings.classList.add("active","earnings-mode"),e&&(e.style.accentColor="#059669")),this.renderFrame(this.state.currentIndex)},discoverTopOperators:async function(){const t=new Set,e=Math.floor(Date.now()/1e3),s=ks*24*60*60;let a=[];for(let r=Qt;r<=e;r+=s)a.push(r);a.push(e);let i="";a.forEach((r,d)=>{i+=`
                t${d}: operatorDailyBuckets(
                    first: 75
                    orderBy: valueWithoutEarnings
                    orderDirection: desc
                    where: { date_gte: "${r}", date_lt: "${r+86400}" }
                ) {
                    operator { id }
                }
            `}),i+=`
            currentTop: operators(
                first: 75
                orderBy: valueWithoutEarnings
                orderDirection: desc
            ) {
                id
            }
        `;const o=`query { ${i} }`;this.els.loadingText&&(this.els.loadingText.textContent=`Scanning history (${a.length} snapshots)...`),this.els.loadingBar&&(this.els.loadingBar.style.width="30%");const n=await(await fetch(kt,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:o})})).json();if(n.errors)throw new Error(n.errors[0].message);return Object.values(n.data).forEach(r=>{r.forEach(d=>{const c=d.operator?d.operator.id:d.id;t.add(c)})}),console.log(`Found ${t.size} distinct operators.`),Array.from(t)},fetchData:async function(){const t=await this.discoverTopOperators();this.state.allOperatorIds=t,this.els.loadingText&&(this.els.loadingText.textContent="Fetching details..."),this.els.loadingBar&&(this.els.loadingBar.style.width="50%");const e=100;for(let l=0;l<t.length;l+=e){const n=t.slice(l,l+e),r=`
                query {
                    operators(where: { id_in: ${JSON.stringify(n)} }, first: 1000) {
                        id
                        metadataJsonString
                    }
                }
            `,c=await(await fetch(kt,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:r})})).json();c.data&&c.data.operators&&c.data.operators.forEach(g=>{const h=Ts(g.metadataJsonString,g.id);this.state.operatorMetaMap[g.id]={name:h.name,color:Zt[parseInt(g.id.slice(-2),16)%Zt.length]}})}this.els.loadingText&&(this.els.loadingText.textContent="Reconstructing timeline...");let s=[],a=Qt,i=!0,o=50;for(;i;){o=Math.min(o+5,95),this.els.loadingBar&&(this.els.loadingBar.style.width=`${o}%`);const r=await(await fetch(kt,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:`
                query GetHistory($ids: [ID!], $since: BigInt!) {
                    operatorDailyBuckets(
                        where: { operator_in: $ids, date_gt: $since }
                        first: 1000
                        orderBy: date
                        orderDirection: asc
                    ) {
                        date
                        valueWithoutEarnings
                        cumulativeEarningsWei
                        operator { id }
                    }
                }
            `,variables:{ids:t,since:a.toString()}})})).json();if(r.errors)throw new Error("History error");const d=r.data.operatorDailyBuckets;d.length===0?i=!1:(s=[...s,...d],a=d[d.length-1].date,d.length<1e3&&(i=!1))}this.state.rawBuckets=s,this.els.loadingBar&&(this.els.loadingBar.style.width="100%"),this.processTimeline(s,t),this.state.timelineData.length>0&&(this.state.currentIndex=this.state.timelineData.length-1),this.els.loadingState&&this.els.loadingState.classList.add("hidden"),this.els.chartArea&&this.els.chartArea.classList.remove("hidden"),this.renderFrame(this.state.currentIndex)},processTimeline:function(t,e){const s={},a=new Set,i=["old","testnet","deprecated"];t.forEach(n=>{const r=parseInt(n.date);a.add(r),s[r]||(s[r]={}),s[r][n.operator.id]={stake:n.valueWithoutEarnings,earnings:n.cumulativeEarningsWei}});const o=Array.from(a).sort((n,r)=>n-r);if(o.length===0)throw new Error("No data found");let l={};e.forEach(n=>l[n]={stake:"0",earnings:"0"}),this.state.timelineData=o.map(n=>{const r=s[n];r&&Object.keys(r).forEach(h=>{r[h].stake&&(l[h].stake=r[h].stake),r[h].earnings&&(l[h].earnings=r[h].earnings)});const d=e.filter(h=>{if(!this.state.operatorMetaMap[h])return!1;if(this.state.filterDeprecated){const p=this.state.operatorMetaMap[h].name.toLowerCase();return!i.some(f=>p.includes(f))}return!0}),c=d.map(h=>({id:h,valueWei:l[h].stake,floatValue:parseFloat(l[h].stake),...this.state.operatorMetaMap[h]})).sort((h,p)=>p.floatValue-h.floatValue).slice(0,Mt),g=d.map(h=>({id:h,valueWei:l[h].earnings,floatValue:parseFloat(l[h].earnings),...this.state.operatorMetaMap[h]})).sort((h,p)=>p.floatValue-h.floatValue).slice(0,Mt);return{date:n,formattedDate:Ds(n),stake:c,earnings:g}}),this.els.slider&&(this.els.slider.max=Math.max(0,this.state.timelineData.length-1)),this.state.timelineData.length>0&&this.els.lblCurrentDate&&(this.els.lblCurrentDate.textContent=this.state.timelineData[0].formattedDate)},renderFrame:function(t){const e=this.state.timelineData[t];if(!e)return;this.els.lblCurrentDate&&(this.els.lblCurrentDate.textContent=e.formattedDate),this.els.slider&&(this.els.slider.value=t);const s=new Date(e.date*1e3),a=s.getFullYear(),i=s.toLocaleDateString("en-US",{month:"short",day:"numeric"});this.els.bgYearDisplay&&(this.els.bgYearDisplay.textContent=a),this.els.bgDayDisplay&&(this.els.bgDayDisplay.textContent=i);const o=this.state.activeMetric==="stake"?e.stake:e.earnings,l=o.length>0?o[0].floatValue:1,n=l/1e18,r=Bs(n),d=new Set(o.map(c=>c.id));o.forEach((c,g)=>{let h=this.state.domElements.get(c.id);h||(h=document.createElement("div"),h.className="bar-row",h.style.top="700px",h.innerHTML=`
                    <div class="w-6 text-[12px] text-gray-500 font-bold text-right shrink-0 rank-num"></div>
                    <div class="w-48 flex items-center justify-end shrink-0">
                        <span class="text-[12px] font-medium text-gray-300 truncate max-w-full text-right operator-name"></span>
                    </div>
                    <div class="flex-1 flex items-center gap-2 h-full bar-track">
                        <div class="bar-fill shadow-sm bg-opacity-90 relative"></div>
                        <span class="text-[9px] font-bold text-gray-400 tabular-nums value-text whitespace-nowrap"></span>
                    </div>
                `,h.querySelector(".operator-name").textContent=c.name,h.querySelector(".operator-name").title=c.name,h.querySelector(".bar-fill").classList.add(...c.color.split(" ")),this.els.barsContainer.appendChild(h),this.state.domElements.set(c.id,h)),h.classList.remove("bar-hidden"),h.style.top=`${g*Xt}px`,h.querySelector(".rank-num").textContent=g+1;const p=c.floatValue/1e18,f=Math.max(c.floatValue/l*100,.5),v=h.querySelector(".bar-fill");if(v.style.width=`${f}%`,h.querySelector(".value-text").textContent=Ms(c.valueWei),v.querySelectorAll(".scale-marker-line").forEach(m=>m.remove()),p>0){const m=Math.floor(p/r),E=Math.min(m,100);for(let A=1;A<=E;A++){const S=A*r/p*100;if(S<99){const T=document.createElement("div");T.className="scale-marker-line",T.style.left=`${S}%`,v.appendChild(T)}}}}),this.state.domElements.forEach((c,g)=>{d.has(g)||(c.classList.add("bar-hidden"),c.style.top="700px")})},togglePlay:function(){this.state.isPlaying=!this.state.isPlaying,this.updatePlayButton(),this.state.isPlaying?(this.state.currentIndex>=this.state.timelineData.length-1&&(this.state.currentIndex=0),this.loop()):clearTimeout(this.state.timer)},loop:function(){if(this.state.isPlaying){if(this.renderFrame(this.state.currentIndex),this.state.currentIndex>=this.state.timelineData.length-1){this.state.isPlaying=!1,this.updatePlayButton();return}this.state.currentIndex++,this.state.timer=setTimeout(()=>this.loop(),this.state.playbackSpeed)}},updatePlayButton:function(){this.els.btnPlay&&(this.state.isPlaying?(this.els.btnPlay.innerHTML='<i data-lucide="pause" class="w-3 h-3 fill-current"></i>',this.els.btnPlay.classList.add("pulse-active")):(this.els.btnPlay.innerHTML='<i data-lucide="play" class="w-3 h-3 ml-0.5 fill-current"></i>',this.els.btnPlay.classList.remove("pulse-active")),window.lucide&&window.lucide.createIcons())},toggleSpeed:function(){this.state.playbackSpeed=this.state.playbackSpeed===100?30:100;const t=this.els.btnSpeed;t&&(this.state.playbackSpeed===30?(t.classList.add("text-blue-400"),t.classList.remove("text-gray-400")):(t.classList.remove("text-blue-400"),t.classList.add("text-gray-400")))},toggleFilter:function(){this.state.filterDeprecated=!this.state.filterDeprecated,this.els.loadingMini&&this.els.loadingMini.classList.remove("hidden"),setTimeout(()=>{this.state.rawBuckets.length>0&&(this.processTimeline(this.state.rawBuckets,this.state.allOperatorIds),this.renderFrame(this.state.currentIndex)),this.els.loadingMini&&this.els.loadingMini.classList.add("hidden")},50)}},As="bb77dd994c8e90edcbd73661a326f068",Os="EGWFdhhiWypDuz22Uy7b3F69E9MEkyfU9iAQMttkH5Rj";function ct(){const t=localStorage.getItem("streamr_explorer_thegraph_api_key");return`https://gateway.thegraph.com/api/${t&&t.trim()!==""?t:As}/subgraphs/id/${Os}`}const te="#f97316",Ns="#ef4444",ut="#3b82f6",Ps="#BFC8D9",$s="#10b981",Rs="#f97316",ee=1750852800,Fs=2.2,Hs=5,Ws=$s,Rt={nodes:[],links:[],simulation:null,canvas:null,ctx:null,transform:null,width:window.innerWidth,height:window.innerHeight,hoveredNode:null,latestBlock:0,latestTimestamp:0,currentViewTimestamp:0,isPlaying:!1,sliderValue:100,isLiveMode:!1,isP2PMode:!1,isShowDelegators:!1,streamrClient:null,coordinationSubscriptions:new Map,operatorNodeCounts:new Map,operatorNodeMetadata:new Map,operatorSponsorshipLinks:new Map,nodeHeartbeats:new Map,nodeSponsorshipAssignments:new Map,p2pTopologyState:new Map,operatorSearchIndex:[],selectedOperatorId:null,operatorSubscriptionQueue:[],activeOperatorSubscriptions:new Set,nodeHeartbeatCounts:new Map,MAX_CONCURRENT_SUBSCRIPTIONS:75,targetNodeDegree:4,timeJumpStep:.5,refreshDelayMs:150,phyGravity:.05,phyFriction:.05,phyRepulsion:2,phyTension:.05,dataCache:new Map,imageCache:new Map,selectedNodeId:null,renderRequested:!1,isDragging:!1,isActive:!1,boundResize:null,boundKeydown:null,setClient:function(t){this.streamrClient=t},resetSettings:function(){this.sliderValue=100,this.isLiveMode=!1,this.isP2PMode=!1,this.isShowDelegators=!1,this.MAX_CONCURRENT_SUBSCRIPTIONS=75,this.targetNodeDegree=4,this.timeJumpStep=.5,this.refreshDelayMs=150,this.phyGravity=.05,this.phyFriction=.05,this.phyRepulsion=2,this.phyTension=.05;const t=(p,f)=>{const v=document.getElementById(p);v&&(v.value=f)},e=(p,f)=>{const v=document.getElementById(p);v&&(v.checked=f)},s=(p,f)=>{const v=document.getElementById(p);v&&(v.textContent=f)};t("vis-time-slider",100),e("vis-live-mode-toggle",!1),e("vis-p2p-mode-toggle",!1),e("vis-delegator-mode-toggle",!1),t("vis-gravity-slider",50),s("vis-gravity-display","0.050"),t("vis-friction-slider",5),s("vis-friction-display","0.05"),t("vis-repulsion-slider",20),s("vis-repulsion-display","2.0x"),t("vis-tension-slider",5),s("vis-tension-display","0.05"),t("vis-max-subs-slider",75),s("vis-max-subs-display","75"),t("vis-degree-slider",4),s("vis-degree-display","4"),t("vis-jump-slider",5),s("vis-jump-display","0.5%"),t("vis-delay-slider",150),s("vis-delay-display","150ms");const a=document.getElementById("vis-time-controls-group"),i=document.getElementById("vis-timeline-settings-group"),o=document.getElementById("vis-discovery-settings-group"),l=document.getElementById("vis-simulation-settings-group"),n=document.getElementById("vis-p2p-mode-container"),r=document.getElementById("vis-delegator-settings-container"),d=document.getElementById("vis-delegator-counter"),c=document.getElementById("vis-live-info-icon");a&&a.classList.remove("hidden"),r&&r.classList.remove("hidden"),d&&d.classList.remove("hidden"),i&&i.classList.remove("hidden"),o&&o.classList.add("hidden"),l&&l.classList.add("hidden"),n&&n.classList.add("hidden"),c&&c.classList.add("hidden");const g=document.getElementById("vis-control-title"),h=document.getElementById("vis-mode-icon");g&&(g.textContent="Live Node View",g.className="text-xs font-medium text-gray-300"),h&&(h.setAttribute("data-lucide","network"),h.classList.replace("text-green-400","text-gray-400"))},init:async function(){if(this.isActive)return;this.isActive=!0,this.resetSettings(),document.body.classList.add("visual-mode-active"),this.canvas=document.getElementById("vis-network-canvas"),this.ctx=this.canvas.getContext("2d"),this.transform=d3.zoomIdentity,this.boundResize=()=>this.resize(),this.boundKeydown=o=>this.handleKeydown(o),window.addEventListener("resize",this.boundResize),document.addEventListener("keydown",this.boundKeydown),this.resize();const t=d3.zoom().scaleExtent([.1,8]).on("zoom",o=>this.zoomed(o));d3.select(this.canvas).call(d3.drag().container(this.canvas).subject(o=>this.dragSubject(o)).on("start",o=>this.dragStarted(o)).on("drag",o=>this.dragged(o)).on("end",o=>this.dragEnded(o))).call(t).on("dblclick.zoom",null).on("click",o=>this.handleCanvasClick(o)).call(t.transform,d3.zoomIdentity.translate(this.width/2,this.height/2).scale(.2).translate(-this.width/2,-this.height/2)).on("mousemove",o=>this.mouseMoved(o)),this.addSafeListener("vis-time-slider","input",o=>this.handleSliderInput(o)),this.addSafeListener("vis-time-slider","change",o=>this.handleSliderChange(o)),this.addSafeListener("vis-btn-play","click",()=>this.togglePlay()),this.addSafeListener("vis-btn-close-sel","click",()=>{this.selectedNodeId=null,this.selectedOperatorId=null,this.updateSelectionUI(null),this.requestRender()}),this.addSafeListener("vis-btn-settings","click",()=>{const o=document.getElementById("vis-settings-panel");o&&o.classList.toggle("hidden");const l=document.getElementById("vis-btn-help");l&&l.classList.toggle("hidden")});const e=document.getElementById("vis-search-input"),s=document.getElementById("vis-btn-clear-search"),a=document.getElementById("vis-btn-search-toggle"),i=document.getElementById("vis-search-bar");a&&i&&e&&a.addEventListener("click",()=>{i.classList.contains("w-64")||(i.classList.remove("w-10","rounded-full"),i.classList.add("w-64","rounded-xl"),e.classList.remove("w-0","opacity-0"),e.classList.add("w-full","opacity-100","ml-2")),e.focus()}),e&&(e.addEventListener("input",o=>this.handleSearch(o.target.value)),e.addEventListener("focus",()=>{const o=document.getElementById("vis-search-results");e.value.length>0&&o&&o.classList.remove("hidden")})),this.searchCloser=o=>{if(!this.isActive)return;const l=document.getElementById("vis-search-wrapper"),n=document.getElementById("vis-search-results");l&&n&&!l.contains(o.target)&&(n.classList.add("hidden"),e&&e.value===""&&i&&(i.classList.remove("w-64","rounded-xl"),i.classList.add("w-10","rounded-full"),e.classList.remove("w-full","opacity-100","ml-2"),e.classList.add("w-0","opacity-0")))},document.addEventListener("click",this.searchCloser),s&&e&&s.addEventListener("click",()=>{e.value="";const o=document.getElementById("vis-search-results");o&&o.classList.add("hidden"),s.classList.add("hidden"),e.focus(),this.requestRender()}),this.addSafeListener("vis-live-mode-toggle","change",o=>this.toggleLiveMode(o.target.checked)),this.addSafeListener("vis-p2p-mode-toggle","change",o=>{this.isP2PMode=o.target.checked,this.regenerateLiveNodes(),this.requestRender()}),this.addSafeListener("vis-delegator-mode-toggle","change",o=>{this.isShowDelegators=o.target.checked,this.loadData()}),this.initSettingsSliders(),window.lucide&&lucide.createIcons(),await this.fetchMetadata(),this.loadData()},stop:function(){this.isActive=!1,document.body.classList.remove("visual-mode-active"),this.simulation&&(this.simulation.stop(),this.simulation=null),this.boundResize&&window.removeEventListener("resize",this.boundResize),this.boundKeydown&&document.removeEventListener("keydown",this.boundKeydown),this.searchCloser&&document.removeEventListener("click",this.searchCloser),this.cleanupLiveMode(),this.nodes=[],this.links=[],this.imageCache.clear(),this.dataCache.clear(),this.isPlaying=!1},addSafeListener:function(t,e,s){const a=document.getElementById(t);a&&a.addEventListener(e,s)},handleKeydown:function(t){if(this.isActive&&!(t.target.tagName==="INPUT"&&t.target.type==="text"))switch(t.key.toLowerCase()){case"h":this.toggleUI();break;case"s":this.cycleSponsorshipSelection();break;case"o":this.cycleOperatorSelection();break}},toggleUI:function(){const t=document.getElementById("vis-ui-layer");t&&t.classList.toggle("hidden")},cycleSponsorshipSelection:function(){const t=this.nodes.filter(a=>a.type==="sponsorship");if(t.length===0)return;let e=0;if(this.selectedNodeId){const a=t.findIndex(i=>i.id===this.selectedNodeId);a!==-1&&(e=(a+1)%t.length)}const s=t[e];this.selectNode(s)},cycleOperatorSelection:function(){let t=[];if(this.isLiveMode){const s=new Set;this.nodes.forEach(a=>{a.type==="live-node"&&!s.has(a.operatorId)&&(s.add(a.operatorId),t.push(a))})}else t=this.nodes.filter(s=>s.type==="operator");if(t.length===0)return;let e=0;if(this.selectedOperatorId){const s=t.findIndex(a=>this.isLiveMode?a.operatorId===this.selectedOperatorId:a.id===this.selectedOperatorId);s!==-1&&(e=(s+1)%t.length)}this.selectNode(t[e])},findNodeUnderPointer:function(t){const[e,s]=d3.pointer(t,this.canvas),a=(e-this.transform.x)/this.transform.k,i=(s-this.transform.y)/this.transform.k;for(let o=this.nodes.length-1;o>=0;o--){const l=this.nodes[o],r=t.sourceEvent&&t.sourceEvent.type&&t.sourceEvent.type.startsWith("touch")||t.pointerType==="touch"?40:10,d=l.radius+(l.type==="live-node"?20:0)+r;if((a-l.x)**2+(i-l.y)**2<d**2)return{node:l,wx:a,wy:i}}return null},dragSubject:function(t){const e=this.findNodeUnderPointer(t);return e&&e.node.id===this.selectedNodeId?(e.node.x=e.wx,e.node.y=e.wy,e.node):null},dragStarted:function(t){this.isDragging=!0,t.active||this.simulation.alphaTarget(.3).restart(),t.subject.fx=t.subject.x,t.subject.fy=t.subject.y},dragged:function(t){t.subject.fx=t.x,t.subject.fy=t.y},dragEnded:function(t){this.isDragging=!1,t.active||this.simulation.alphaTarget(.01),this.isLiveMode&&t.subject.type==="sponsorship"?(t.subject.fx=t.x,t.subject.fy=t.subject.y):(t.subject.fx=null,t.subject.fy=null)},handleCanvasClick:function(t){if(this.isDragging)return;const e=this.findNodeUnderPointer(t);e?this.selectNode(e.node):this.selectNode(null)},selectNode:function(t){t?(this.selectedNodeId=t.id,t.type==="live-node"?this.selectedOperatorId=t.operatorId:t.type==="operator"?this.selectedOperatorId=t.id:this.selectedOperatorId=null,this.updateSelectionUI(t)):(this.selectedNodeId=null,this.selectedOperatorId=null,this.updateSelectionUI(null)),this.requestRender()},handleSearch:function(t){const e=document.getElementById("vis-search-results"),s=document.getElementById("vis-btn-clear-search");if(!t||t.trim()===""){e.classList.add("hidden"),s.classList.add("hidden");return}s.classList.remove("hidden");const a=t.toLowerCase(),i=this.operatorSearchIndex.filter(o=>o.name.toLowerCase().includes(a)||o.id.toLowerCase().includes(a)).slice(0,10);i.length===0?e.innerHTML='<div class="p-3 text-gray-500 text-xs text-center">No results found</div>':(e.innerHTML=i.map(o=>`
                <div class="search-item p-3 hover:bg-white/5 cursor-pointer flex items-center gap-3 transition-colors border-b border-white/5 last:border-none" data-id="${o.id}">
                    <div class="w-8 h-8 rounded-full ${o.type==="operator"?"bg-blue-500/20 text-blue-400":"bg-orange-500/20 text-orange-400"} border border-white/10 flex items-center justify-center text-[10px] font-bold shrink-0">
                        ${o.type==="operator"?"OP":"DEL"}
                    </div>
                    <div class="min-w-0 flex-1">
                        <div class="text-xs font-bold text-white truncate">${o.name}</div>
                        <div class="text-[10px] font-mono text-gray-500 truncate">${o.id.substring(0,16)}...</div>
                    </div>
                    <i data-lucide="chevron-right" class="w-3 h-3 text-gray-600"></i>
                </div>
            `).join(""),window.lucide&&window.lucide.createIcons({root:e}),e.querySelectorAll(".search-item").forEach(o=>{o.addEventListener("click",()=>{const l=o.getAttribute("data-id");this.selectEntityFromSearch(l),e.classList.add("hidden"),document.getElementById("vis-search-input").value=i.find(n=>n.id===l).name})})),e.classList.remove("hidden")},selectEntityFromSearch:function(t){let e=this.nodes.find(s=>s.id===t);if(e){this.selectNode(e);const s=2,a=-e.x*s+this.width/2,i=-e.y*s+this.height/2;d3.select(this.canvas).transition().duration(750).call(d3.zoom().transform,d3.zoomIdentity.translate(a,i).scale(s))}else this.isLiveMode&&this.selectOperatorFromSearch(t);this.requestRender()},selectOperatorFromSearch:function(t){this.selectedOperatorId=t;let e=null;if(e=this.nodes.find(s=>s.id===t),e||(e=this.nodes.find(s=>s.type==="live-node"&&s.operatorId===t)),e){this.selectedNodeId=e.id,this.updateSelectionUI(e);const s=2,a=-e.x*s+this.width/2,i=-e.y*s+this.height/2;d3.select(this.canvas).transition().duration(750).call(d3.zoom().transform,d3.zoomIdentity.translate(a,i).scale(s))}else{const s=this.operatorNodeMetadata.get(t);if(s){const a={id:t,type:"operator",label:s.label,val:0,operatorId:t};this.isLiveMode&&(a.type="live-node"),this.updateSelectionUI(a)}}this.requestRender()},toggleLiveMode:async function(t){if(t===this.isLiveMode)return;this.isLiveMode=t,this.isPlaying=!1;const e=document.getElementById("vis-control-title"),s=document.getElementById("vis-mode-icon"),a=document.getElementById("vis-live-info-icon"),i=document.getElementById("vis-time-controls-group"),o=document.getElementById("vis-timeline-settings-group"),l=document.getElementById("vis-discovery-settings-group"),n=document.getElementById("vis-simulation-settings-group"),r=document.getElementById("vis-p2p-mode-container"),d=document.getElementById("vis-entity-counter"),c=document.getElementById("vis-delegator-settings-container"),g=document.getElementById("vis-delegator-counter");t?(e.textContent="Live Node View",e.className="text-xs font-medium text-green-400",s&&(s.setAttribute("data-lucide","network"),s.classList.replace("text-gray-400","text-green-400")),a&&a.classList.remove("hidden"),d.innerHTML='<div class="flex items-center gap-2"><div class="w-3 h-3 border-2 border-gray-500 border-t-transparent rounded-full animate-spin"></div><span>CONNECTING</span></div>',i&&i.classList.add("hidden"),c&&c.classList.add("hidden"),g&&g.classList.add("hidden"),o&&o.classList.add("hidden"),l&&l.classList.remove("hidden"),n&&n.classList.remove("hidden"),r&&r.classList.remove("hidden")):(e.textContent="Live Node View",e.className="text-xs font-medium text-gray-300",s&&(s.setAttribute("data-lucide","network"),s.classList.replace("text-green-400","text-gray-400")),a&&a.classList.add("hidden"),i&&i.classList.remove("hidden"),c&&c.classList.remove("hidden"),o&&o.classList.remove("hidden"),l&&l.classList.add("hidden"),n&&n.classList.add("hidden"),r&&r.classList.add("hidden")),window.lucide&&window.lucide.createIcons(),t?(this.streamrClient||console.warn("VisualLogic: StreamrClient not set via setClient(). Live mode may fail."),this.loadData()):(await this.cleanupLiveMode(),this.loadData())},cleanupLiveMode:async function(){this.isLiveMode=!1,this.operatorSubscriptionQueue=[],this.activeOperatorSubscriptions.clear();const t=[];this.coordinationSubscriptions.forEach(e=>{t.push(e.unsubscribe())}),await Promise.all(t),this.coordinationSubscriptions.clear(),this.operatorNodeCounts.clear(),this.operatorNodeMetadata.clear(),this.operatorSponsorshipLinks.clear(),this.nodeHeartbeats.clear(),this.nodeSponsorshipAssignments.clear(),this.p2pTopologyState.clear(),this.nodeHeartbeatCounts.clear()},subscribeToOperator:async function(t){if(this.coordinationSubscriptions.has(t)||!this.isLiveMode||!this.streamrClient)return;const e=`${t}/operator/coordination`;this.operatorNodeCounts.set(t,new Set),this.nodeHeartbeatCounts.set(t,new Map),setTimeout(()=>{this.isLiveMode&&this.activeOperatorSubscriptions.has(t)&&this.rotateOperatorSubscription(t)},45e3);try{if(!this.streamrClient)return;const s=await this.streamrClient.subscribe(e,a=>{this.handleCoordinationMessage(t,a)});if(!this.isLiveMode){await s.unsubscribe();return}this.coordinationSubscriptions.set(t,s)}catch(s){if(s?.code==="CLIENT_DESTROYED"||s?.message?.includes("destroyed"))return;console.error(`Error subscribing to ${e}:`,s),this.coordinationSubscriptions.delete(t)}},handleCoordinationMessage:function(t,e){if(e?.msgType==="heartbeat"&&e?.peerDescriptor?.nodeId){const s=e.peerDescriptor.nodeId,a=Date.now();this.nodeHeartbeats.set(s,a);const i=this.operatorNodeCounts.get(t);i&&!i.has(s)&&i.add(s);let o=this.nodeHeartbeatCounts.get(t);o||(o=new Map,this.nodeHeartbeatCounts.set(t,o));const l=(o.get(s)||0)+1;if(o.set(s,l),o.size>0){let n=!0;for(const r of o.values())if(r<2){n=!1;break}n&&this.rotateOperatorSubscription(t)}this.regenerateLiveNodes(),this.requestRender()}},rotateOperatorSubscription:async function(t){const e=this.coordinationSubscriptions.get(t);e&&(await e.unsubscribe(),this.coordinationSubscriptions.delete(t)),this.activeOperatorSubscriptions.delete(t),this.nodeHeartbeatCounts.delete(t),this.manageSubscriptions()},manageSubscriptions:function(){for(;this.activeOperatorSubscriptions.size>this.MAX_CONCURRENT_SUBSCRIPTIONS;){const[t]=this.activeOperatorSubscriptions,e=this.coordinationSubscriptions.get(t);e&&e.unsubscribe(),this.coordinationSubscriptions.delete(t),this.activeOperatorSubscriptions.delete(t),this.nodeHeartbeatCounts.delete(t)}for(;this.activeOperatorSubscriptions.size<this.MAX_CONCURRENT_SUBSCRIPTIONS&&this.operatorSubscriptionQueue.length>0;){const t=this.operatorSubscriptionQueue.shift();this.operatorSubscriptionQueue.push(t),this.activeOperatorSubscriptions.add(t),this.subscribeToOperator(t)}},regenerateLiveNodes:function(){if(!this.isLiveMode)return;const t=[],e=[],s=new Map,a=this.nodes.filter(l=>l.type==="sponsorship");t.push(...a),this.operatorNodeCounts.forEach((l,n)=>{const r=this.operatorNodeMetadata.get(n);if(!r)return;const d=Array.from(l).filter(h=>this.nodeHeartbeats.has(h)),c=Array.from(this.operatorSponsorshipLinks.get(n)||[]),g=r.redundancyFactor||1;d.forEach((h,p)=>{const f=`node-${h}`;let v=this.nodes.find(C=>C.id===f);const x=v||{id:f,type:"live-node",operatorId:n,radius:Hs,label:`Node ${h.slice(0,4)}`,x:r.x+(p%5-2)*20,y:r.y+(Math.floor(p/5)-2)*20,nodeIndex:p+1};v&&(x.nodeIndex=p+1),v?(x.vx=v.vx,x.vy=v.vy):(x.x=r.x+(Math.random()-.5)*10,x.y=r.y+(Math.random()-.5)*10,x.vx=r.vx||0,x.vy=r.vy||0),t.push(x);let m=[];this.nodeSponsorshipAssignments.has(f)?m=this.nodeSponsorshipAssignments.get(f):(c.length>0&&(c.length<=g?m=c:m=[...c].sort(()=>.5-Math.random()).slice(0,g)),this.nodeSponsorshipAssignments.set(f,m));const E=new Set(a.map(C=>C.id)),A=new Set(c);m=m.filter(C=>E.has(C)&&A.has(C)),m.length<this.nodeSponsorshipAssignments.get(f)?.length&&this.nodeSponsorshipAssignments.set(f,m),this.isP2PMode?m.forEach(C=>{s.has(C)||s.set(C,[]),s.get(C).push(f)}):m.forEach(C=>{e.push({source:f,target:C,value:1})})})}),this.isP2PMode&&s.forEach((l,n)=>{let r=this.p2pTopologyState.get(n);r||(r=new Set,this.p2pTopologyState.set(n,r));const d=new Map;l.forEach(v=>d.set(v,0));const c=new Set,g=new Map;l.forEach(v=>g.set(v,[])),r.forEach(v=>{const[x,m]=v.split("|");d.has(x)&&d.has(m)&&d.get(x)<this.targetNodeDegree&&d.get(m)<this.targetNodeDegree&&(d.set(x,d.get(x)+1),d.set(m,d.get(m)+1),c.add(v),g.get(x).push(m),g.get(m).push(x))});const h=new Set,p=[];if(l.forEach(v=>{if(!h.has(v)){const x=[],m=[v];for(h.add(v);m.length>0;){const E=m.shift();x.push(E),(g.get(E)||[]).forEach(C=>{h.has(C)||(h.add(C),m.push(C))})}p.push(x)}}),p.length>1)for(let v=0;v<p.length-1;v++){const x=p[v],m=p[v+1],E=x.filter(k=>d.get(k)<this.targetNodeDegree),A=m.filter(k=>d.get(k)<this.targetNodeDegree),C=E.length?E[Math.floor(Math.random()*E.length)]:x[Math.floor(Math.random()*x.length)],S=A.length?A[Math.floor(Math.random()*A.length)]:m[Math.floor(Math.random()*m.length)],T=C<S?`${C}|${S}`:`${S}|${C}`;c.has(T)||(c.add(T),d.set(C,d.get(C)+1),d.set(S,d.get(S)+1))}const f=[...l].sort(()=>Math.random()-.5);for(let v=0;v<f.length;v++){const x=f[v];if(!(d.get(x)>=this.targetNodeDegree))for(let m=0;m<f.length;m++){if(v===m)continue;const E=f[m];if(d.get(E)>=this.targetNodeDegree)continue;const A=x<E?`${x}|${E}`:`${E}|${x}`;if(!c.has(A)&&(c.add(A),d.set(x,d.get(x)+1),d.set(E,d.get(E)+1),d.get(x)>=this.targetNodeDegree))break}}this.p2pTopologyState.set(n,c),c.forEach(v=>{const[x,m]=v.split("|");e.push({source:x,target:m,value:1})})});const i=t.filter(l=>l.type==="live-node").length,o=document.getElementById("vis-entity-counter");if(i===0&&this.isLiveMode?o.innerHTML='<div class="flex items-center gap-2"><div class="w-3 h-3 border-2 border-gray-500 border-t-transparent rounded-full animate-spin"></div><span>SEARCHING</span></div>':this.isLiveMode&&(o.textContent=`${i} LIVE NODES`),this.nodes=t,this.links=e,this.simulation?(this.simulation.nodes(this.nodes),this.simulation.force("link").links(this.links),this.simulation.alpha(.3).restart()):this.initSimulation(),this.selectedNodeId){const l=this.nodes.find(n=>n.id===this.selectedNodeId);this.updateSelectionUI(l)}},initSettingsSliders:function(){this.addSafeListener("vis-max-subs-slider","input",t=>{const e=parseInt(t.target.value);this.MAX_CONCURRENT_SUBSCRIPTIONS=e;const s=document.getElementById("vis-max-subs-display");s&&(s.textContent=e),this.isLiveMode&&this.manageSubscriptions()}),this.addSafeListener("vis-degree-slider","input",t=>{const e=parseInt(t.target.value);this.targetNodeDegree=e;const s=document.getElementById("vis-degree-display");s&&(s.textContent=e),this.isLiveMode&&this.regenerateLiveNodes()}),this.addSafeListener("vis-btn-release-nodes","click",()=>{this.nodes.forEach(t=>{t.fx=null,t.fy=null}),this.simulation.alpha(.3).restart()}),this.addSafeListener("vis-jump-slider","input",t=>{const e=parseInt(t.target.value);this.timeJumpStep=e/10;const s=document.getElementById("vis-jump-display");s&&(s.textContent=this.timeJumpStep.toFixed(1)+"%")}),this.addSafeListener("vis-delay-slider","input",t=>{const e=parseInt(t.target.value);this.refreshDelayMs=e;const s=document.getElementById("vis-delay-display");s&&(s.textContent=e+"ms")}),this.addSafeListener("vis-gravity-slider","input",t=>{this.phyGravity=parseInt(t.target.value)/1e3;const e=document.getElementById("vis-gravity-display");e&&(e.textContent=this.phyGravity.toFixed(3)),this.updatePhysics()}),this.addSafeListener("vis-friction-slider","input",t=>{this.phyFriction=parseInt(t.target.value)/100;const e=document.getElementById("vis-friction-display");e&&(e.textContent=this.phyFriction.toFixed(2)),this.updatePhysics()}),this.addSafeListener("vis-repulsion-slider","input",t=>{this.phyRepulsion=parseInt(t.target.value)/10;const e=document.getElementById("vis-repulsion-display");e&&(e.textContent=this.phyRepulsion.toFixed(1)+"x"),this.updatePhysics()}),this.addSafeListener("vis-tension-slider","input",t=>{this.phyTension=parseInt(t.target.value)/100;const e=document.getElementById("vis-tension-display");e&&(e.textContent=this.phyTension.toFixed(2)),this.updatePhysics()})},updatePhysics:function(){this.simulation&&(this.simulation.velocityDecay(this.phyFriction),this.simulation.force("charge").strength(t=>(t.type==="sponsorship"?-3e3:t.type==="operator"?-800:-100)*this.phyRepulsion),this.simulation.force("x").strength(this.phyGravity),this.simulation.force("y").strength(this.phyGravity),this.simulation.force("link").strength(this.phyTension),this.simulation.alpha(.3).restart(),this.requestRender())},resize:function(){this.updateDimensions(),setTimeout(()=>this.updateDimensions(),300)},updateDimensions:function(){this.canvas&&(this.width=window.innerWidth,this.height=window.innerHeight,this.canvas.width=this.width,this.canvas.height=this.height,this.simulation&&(this.simulation.force("center",d3.forceCenter(this.width/2,this.height/2)),this.simulation.alpha(.3).restart()),this.requestRender())},updateSelectionUI:function(t){const e=document.getElementById("vis-selection-card");if(!e)return;if(!t||t.type==="live-node")if(t&&t.type==="live-node")e.classList.remove("hidden");else{e.classList.add("hidden");return}else e.classList.remove("hidden");const s=document.getElementById("vis-sel-type-label"),a=document.getElementById("vis-sel-val"),i=document.getElementById("vis-sel-extra-row"),o=document.getElementById("vis-sel-delegators-row"),l=document.getElementById("vis-sel-avatar"),n=document.getElementById("vis-sel-val-label"),r=document.getElementById("vis-sel-title"),d=document.getElementById("vis-sel-title-tooltip"),c=document.getElementById("vis-sel-count-row"),g=document.getElementById("vis-sel-count-label"),h=document.getElementById("vis-sel-count");if(l.classList.add("hidden"),c.classList.remove("hidden"),o.classList.add("hidden"),t.type==="sponsorship"){r.textContent=t.label,d.textContent=t.label;const p=this.links.filter(f=>f.target.id===t.id||f.target===t.id).length;g.textContent=this.isLiveMode?"Staked Nodes":"Staked Operators",h.textContent=p,n.textContent="Remaining Balance",a.textContent=Math.floor(t.val).toLocaleString()+" DATA",a.className="text-xs font-bold text-orange-400",i.classList.remove("hidden"),document.getElementById("vis-sel-extra").textContent=t.daysLeft.toFixed(1)+" days",s.textContent="SPONSORSHIP",s.className="text-[9px] text-yellow-500 uppercase tracking-widest font-bold mb-0 leading-none",e.className=e.className.replace(/border-l-\w+/,"border-l-yellow-500")}else if(t.type==="operator"&&!this.isLiveMode){r.textContent=t.label,d.textContent=t.label,g.textContent="Sponsorships";const p=this.links.filter(m=>(m.source.id===t.id||m.source===t.id)&&m.target.type!=="operator").length;h.textContent=p,o.classList.remove("hidden");const f=this.operatorNodeMetadata.get(t.id),v=f&&f.delegatorCount?Math.max(0,f.delegatorCount-1):0;document.getElementById("vis-sel-delegators-count").textContent=v,n.textContent="Total Stake",a.textContent=Math.floor(t.val).toLocaleString()+" DATA",a.className="text-xs font-bold text-blue-400",i.classList.add("hidden"),s.textContent="OPERATOR",s.className="text-[9px] text-blue-500 uppercase tracking-widest font-bold mb-0 leading-none",e.className=e.className.replace(/border-l-\w+/,"border-l-blue-500");const x=this.imageCache.get(t.id);x&&x.loaded&&(l.classList.remove("hidden"),l.style.backgroundImage=`url(${x.img.src})`)}else if(t.type==="live-node"){const p=t.operatorId,f=this.operatorNodeMetadata.get(p),v=f?f.label:p.substring(0,12)+"...";r.textContent=v,d.textContent=f?f.label:p;let x=0;const m=this.operatorNodeCounts.get(t.operatorId);m&&(x=m.size),g.textContent="Fleet Size",h.textContent=x,n.textContent="Node ID",a.textContent=`Node #${t.nodeIndex}`,a.className="text-xs font-bold text-white",i.classList.add("hidden"),s.textContent="LIVE NODE",s.className="text-[9px] text-green-500 uppercase tracking-widest font-bold mb-0 leading-none",e.className=e.className.replace(/border-l-\w+/,"border-l-green-500")}else t.type==="delegator"&&(r.textContent=t.label,d.textContent=t.id,c.classList.add("hidden"),n.textContent="Delegated",a.textContent=Math.floor(t.val).toLocaleString()+" DATA",a.className="text-xs font-bold text-orange-400",i.classList.add("hidden"),s.textContent="DELEGATOR",s.className="text-[9px] text-orange-500 uppercase tracking-widest font-bold mb-0 leading-none",e.className=e.className.replace(/border-l-\w+/,"border-l-orange-500"))},fetchMetadata:async function(){const t="{ _meta { block { number timestamp } } }";try{const s=await(await fetch(ct(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:t})})).json();this.latestBlock=s.data._meta.block.number,this.latestTimestamp=s.data._meta.block.timestamp,this.currentViewTimestamp=this.latestTimestamp,this.updateDateDisplay(this.latestTimestamp)}catch(e){console.error(e)}},handleSliderInput:function(t){const e=parseFloat(t.target.value);this.sliderValue=e,t.isTrusted&&this.isPlaying&&this.togglePlay(),this.updateDateFromPercent(e)},updateDateFromPercent:function(t){const e=this.latestTimestamp-ee,s=ee+e*(t/100);return this.updateDateDisplay(s),this.currentViewTimestamp=s,s},handleSliderChange:function(t){this.fetchDataForPercent(parseFloat(t.target.value))},fetchDataForPercent:function(t){const e=this.updateDateFromPercent(t);if(e>=this.latestTimestamp-3600)this.loadData();else{const s=this.latestTimestamp-e,a=Math.floor(s/Fs),i=Math.max(0,this.latestBlock-a);this.loadData(i)}},updateDateDisplay:function(t){const e=new Date(t*1e3),s=document.getElementById("vis-current-date-display");s&&(s.textContent=e.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"}))},togglePlay:function(){if(this.isLiveMode)return;this.isPlaying=!this.isPlaying;const t=document.getElementById("vis-btn-play");if(this.isPlaying){t.innerHTML='<i data-lucide="pause" class="w-3 h-3 fill-current"></i>',t.classList.add("pulse-active");const e=document.getElementById("vis-time-slider");parseFloat(e.value)>=100?(e.value=0,this.sliderValue=0,this.updateDateFromPercent(0),this.fetchDataForPercent(0)):this.advanceTimeline()}else t.innerHTML='<i data-lucide="play" class="w-3 h-3 ml-0.5 fill-current"></i>',t.classList.remove("pulse-active");window.lucide&&window.lucide.createIcons()},advanceTimeline:function(){if(!this.isPlaying||this.isLiveMode)return;const t=document.getElementById("vis-time-slider");let e=this.sliderValue+this.timeJumpStep;if(e>=100){e=100,t.value=e,this.sliderValue=e,this.updateDateFromPercent(e),this.isPlaying&&this.togglePlay(),this.loadData();return}e=Math.round(e*100)/100,t.value=e,this.sliderValue=e,this.updateDateFromPercent(e),this.fetchDataForPercent(e)},loadData:async function(t=null){const e=document.getElementById("vis-loading-indicator"),s=document.getElementById("vis-loading-text");e&&(e.classList.remove("hidden"),e.style.display="flex"),s&&(s.textContent=t?`Block #${t}...`:this.isLiveMode?"Fetching Live Operators...":"Syncing...");try{const a=this.isShowDelegators?`
                delegations(first: 1000, where: { isSelfDelegation: false }) {
                    id
                    delegator { id }
                    _valueDataWei
                }
            `:"";if(this.isLiveMode&&!t){const i=`
                    query GetEntities {
                        operators(first: 1000, skip: 0, orderBy: valueWithoutEarnings, orderDirection: desc, subgraphError: allow) {
                            id metadataJsonString contractVersion delegatorCount
                            ${a}
                        }
                    }
                `,o=`
                    query {
                        sponsorships(first: 100, orderBy: totalStakedWei, orderDirection: desc, where: { isRunning: true }) {
                            id, stream { id }, remainingWei, totalStakedWei, projectedInsolvency
                            stakes(first: 1000, where: { amountWei_gt: "0" }) {
                                operator { id, valueWithoutEarnings, metadataJsonString, delegatorCount, ${a} }, amountWei
                            }
                        }
                    }
                `,[l,n]=await Promise.all([fetch(ct(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:i})}),fetch(ct(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:o})})]),r=await l.json(),d=await n.json();r.data&&r.data.operators&&this.processOperators(r.data.operators),d.data&&d.data.sponsorships&&this.processData(d.data.sponsorships,null)}else{if(t!==null&&this.dataCache.has(t+(this.isShowDelegators?"_del":""))){s&&(s.innerHTML=`Block #${t} <span class="text-emerald-400 ml-2"> CACHE</span>`);const r=this.dataCache.get(t+(this.isShowDelegators?"_del":""));this.processData(r,t);return}t!==null&&s&&(s.innerHTML=`Block #${t} <span class="text-blue-400 ml-2"> API</span>`);const o=`
                    query {
                        sponsorships(first: 100, orderBy: totalStakedWei, orderDirection: desc, where: { isRunning: true } ${t!==null?`, block: { number: ${t} }`:""}) {
                            id, stream { id }, remainingWei, totalStakedWei, projectedInsolvency
                            stakes(first: 1000, where: { amountWei_gt: "0" }) {
                                operator { id, valueWithoutEarnings, metadataJsonString, delegatorCount, ${a} }, amountWei
                            }
                        }
                    }
                `,n=await(await fetch(ct(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:o})})).json();t!==null&&this.dataCache.set(t+(this.isShowDelegators?"_del":""),n.data.sponsorships),this.processData(n.data.sponsorships,t)}}catch(a){console.error(a)}finally{!this.isPlaying&&e&&setTimeout(()=>{e.style.display="none"},200),this.isPlaying&&setTimeout(()=>this.advanceTimeline(),this.refreshDelayMs)}},processOperators:function(t){this.operatorSearchIndex=[],this.operatorSubscriptionQueue=t.map(e=>e.id),this.activeOperatorSubscriptions.clear(),t.forEach(e=>{const s=e.id;let a=`Op ${s.slice(0,5)}`,i=1;try{if(e.metadataJsonString){const l=JSON.parse(e.metadataJsonString);if(l.name&&(a=l.name),l.redundancyFactor){const n=parseInt(l.redundancyFactor);!isNaN(n)&&n>=1&&(i=n)}}}catch{}this.operatorSearchIndex.push({id:s,name:a,type:"operator"});const o=this.operatorNodeMetadata.get(s)||{};this.operatorNodeMetadata.set(s,{x:o.x||this.width/2+(Math.random()-.5)*200,y:o.y||this.height/2+(Math.random()-.5)*200,vx:o.vx||0,vy:o.vy||0,label:a,redundancyFactor:i,delegatorCount:e.delegatorCount||0,delegations:e.delegations||[]})}),this.manageSubscriptions()},processData:function(t,e){const s=new Map,a=[],i=this.currentViewTimestamp||Date.now()/1e3,o=new Set;this.isLiveMode?this.operatorSponsorshipLinks.clear():this.operatorSearchIndex=[],t.forEach(r=>{const d=r.id,c=parseFloat(r.remainingWei)/1e18;let g=Math.max(15,Math.min(Math.sqrt(c)*.36,400)),h=0;const p=parseInt(r.projectedInsolvency);p&&(h=Math.max(0,(p-i)/(24*3600)));const f=r.stream&&r.stream.id?r.stream.id:`Stream ${d.slice(0,6)}`;if(!s.has(d))s.set(d,{id:d,type:"sponsorship",val:c,radius:g,label:f,daysLeft:h,x:this.width/2+(Math.random()-.5)*50,y:this.height/2+(Math.random()-.5)*50});else{const v=s.get(d);v.val=c,v.radius=g,v.daysLeft=h,v.label=f}r.stakes.forEach(v=>{const x=v.operator,m=x.id,E=parseFloat(x.valueWithoutEarnings)/1e18,A=parseFloat(v.amountWei)/1e18;let C=`Op ${m.slice(0,5)}`,S=null,T=1;try{if(x.metadataJsonString){const y=JSON.parse(x.metadataJsonString);if(y.name&&(C=y.name),y.imageIpfsCid&&(S=`https://wsrv.nl/?url=https://ipfs.io/ipfs/${y.imageIpfsCid}&w=120&h=120&output=webp`),y.redundancyFactor){const b=parseInt(y.redundancyFactor);!isNaN(b)&&b>=1&&(T=b)}}}catch{}if(this.isLiveMode||this.operatorSearchIndex.find(y=>y.id===m)||this.operatorSearchIndex.push({id:m,name:C,type:"operator"}),S&&!this.imageCache.has(m)){const y=new Image;y.crossOrigin="Anonymous",y.src=S,this.imageCache.set(m,{loaded:!1,img:y}),y.onload=()=>{this.imageCache.set(m,{loaded:!0,img:y}),this.requestRender()}}const k=s.has(m),N=this.width/2+(Math.random()-.5)*200,M=this.height/2+(Math.random()-.5)*200;if(!k&&!this.isLiveMode){let y=Math.max(5,Math.min(Math.sqrt(E)*.05,150));s.set(m,{id:m,type:"operator",val:E,radius:y,label:C,x:N,y:M})}let R=this.operatorNodeMetadata.get(m)||{};const P=k?s.get(m):R;if(this.operatorNodeMetadata.set(m,{x:P.x||N,y:P.y||M,vx:P.vx||0,vy:P.vy||0,label:C,redundancyFactor:T,delegatorCount:x.delegatorCount||0,delegations:x.delegations||[]}),this.isLiveMode)this.operatorSponsorshipLinks.has(m)||this.operatorSponsorshipLinks.set(m,new Set),this.operatorSponsorshipLinks.get(m).add(d);else{if(k){const y=s.get(m);y.val=E,y.radius=Math.max(5,Math.min(Math.sqrt(E)*.05,150))}a.push({source:m,target:d,value:A}),this.isShowDelegators&&x.delegations&&!o.has(m)&&(o.add(m),x.delegations.forEach(y=>{const b=y.delegator.id,U=parseFloat(y._valueDataWei)/1e18;s.has(b)||(s.set(b,{id:b,type:"delegator",label:`Del ${b.slice(0,4)}`,val:0,radius:4,x:P.x+(Math.random()-.5)*50,y:P.y+(Math.random()-.5)*50}),this.operatorSearchIndex.find(j=>j.id===b)||this.operatorSearchIndex.push({id:b,name:`Delegator ${b.slice(0,6)}...`,type:"delegator"}));const F=s.get(b);F.val+=U,F.radius=Math.max(4,Math.min(Math.sqrt(F.val)*.3,20)),a.push({source:b,target:m,value:U,type:"delegation"})}))}})});let l=Array.from(s.values()),n=a;if(this.simulation){const r=new Map(this.nodes.map(d=>[d.id,d]));l.forEach(d=>{if(r.has(d.id)){const c=r.get(d.id);if(d.x=c.x,d.y=c.y,d.vx=c.vx,d.vy=c.vy,d.type==="operator"||d.type==="sponsorship"){const g=this.operatorNodeMetadata.get(d.id);g&&(g.x=d.x,g.y=d.y,g.vx=d.vx,g.vy=d.vy,this.operatorNodeMetadata.set(d.id,g))}}})}if(!this.isLiveMode){const r=l.filter(g=>g.type==="operator").length;let d=`${r} OPERATORS`;if(this.isShowDelegators){const g=l.filter(h=>h.type==="delegator").length;d=`${r} OPS, ${g} DELEGATORS`}const c=document.getElementById("vis-entity-counter");c&&(c.textContent=d)}if(this.nodes=l,this.links=n,this.isLiveMode&&(this.simulation?.stop(),this.regenerateLiveNodes()),this.selectedNodeId){const r=this.nodes.find(d=>d.id===this.selectedNodeId);this.updateSelectionUI(r)}this.simulation?(this.simulation.nodes(this.nodes),this.simulation.force("link").links(this.links),this.simulation.alpha(.3).restart()):this.initSimulation()},initSimulation:function(){this.simulation&&this.simulation.stop(),this.simulation=d3.forceSimulation(this.nodes).velocityDecay(this.phyFriction).force("link",d3.forceLink(this.links).id(t=>t.id).distance(t=>t.type==="delegation"?30:this.isLiveMode&&t.source.type==="live-node"?t.source.radius+t.target.radius+15:t.source.radius+t.target.radius+50).strength(t=>{const e=this.phyTension;if(!t.value)return e;const s=1+Math.log1p(t.value)*.1;return Math.min(e*s,1)})).force("charge",d3.forceManyBody().strength(t=>t.type==="delegator"?-50:(t.type==="sponsorship"?-3e3:t.type==="operator"?-800:-100)*this.phyRepulsion)).force("collide",d3.forceCollide().radius(t=>t.radius+(this.isLiveMode&&t.type==="live-node"?1:10)).iterations(2)).force("center",d3.forceCenter(this.width/2,this.height/2)).force("x",d3.forceX(this.width/2).strength(this.phyGravity)).force("y",d3.forceY(this.height/2).strength(this.phyGravity)).alpha(.3).alphaTarget(.02).alphaDecay(.03).restart().on("tick",()=>{this.isLiveMode&&this.nodes.filter(t=>t.type==="sponsorship").forEach(t=>{const e=this.operatorNodeMetadata.get(t.id);e&&(e.x=t.x,e.y=t.y,e.vx=t.vx,e.vy=t.vy,this.operatorNodeMetadata.set(t.id,e))}),this.requestRender()})},requestRender:function(){this.renderRequested||(this.renderRequested=!0,requestAnimationFrame(()=>{this.render(),this.renderRequested=!1,this.isLiveMode&&this.isActive&&this.requestRender()}))},render:function(){const t=this.ctx;if(!t)return;t.save(),t.clearRect(0,0,this.width,this.height),t.translate(this.transform.x,this.transform.y),t.scale(this.transform.k,this.transform.k);const e=this.nodes.find(n=>n.id===this.selectedNodeId),s=!!e,a=e&&e.type==="sponsorship"&&this.isP2PMode?this.p2pTopologyState.get(e.id):null,i=[],o=[],l=[];this.links.forEach(n=>{let r=!1;const d=n.source,c=n.target,g=d.id||d,h=c.id||c;if(s){if((g===this.selectedNodeId||h===this.selectedNodeId)&&(r=!0),e.type==="sponsorship"&&this.isP2PMode){const p=g<h?`${g}|${h}`:`${h}|${g}`;a&&a.has(p)&&(r=!0)}if(this.isLiveMode&&this.selectedOperatorId){const p=d.operatorId===this.selectedOperatorId,f=c.operatorId===this.selectedOperatorId;(p||f)&&(r=!0)}}r?n.type==="delegation"?l.push(n):o.push(n):i.push(n)}),i.length>0&&(t.beginPath(),i.forEach(n=>{t.moveTo(n.source.x,n.source.y),t.lineTo(n.target.x,n.target.y)}),t.strokeStyle=Ps,t.lineWidth=1.5,t.stroke()),o.length>0&&(t.save(),t.beginPath(),o.forEach(n=>{t.moveTo(n.source.x,n.source.y),t.lineTo(n.target.x,n.target.y)}),t.shadowBlur=30,t.shadowColor="rgba(255, 255, 255, 0.9)",t.strokeStyle="#ffffff",t.lineWidth=5.5,t.stroke(),t.restore()),l.length>0&&(t.save(),t.beginPath(),l.forEach(n=>{t.moveTo(n.source.x,n.source.y),t.lineTo(n.target.x,n.target.y)}),t.shadowBlur=6,t.shadowColor="rgba(255, 255, 255, 0.4)",t.strokeStyle="#c4c4c4",t.lineWidth=2,t.stroke(),t.restore()),this.nodes.forEach(n=>{let r=!1;const d=this.imageCache.get(n.id);let c=!1;if(this.selectedOperatorId&&(n.type==="live-node"&&n.operatorId===this.selectedOperatorId&&(c=!0),n.type==="operator"&&n.id===this.selectedOperatorId&&(c=!0)),n.type==="live-node"){const g=this.selectedNodeId===n.id;if(t.beginPath(),g?t.fillStyle="#fbbf24":c?t.fillStyle="#60a5fa":t.fillStyle=Ws,t.arc(n.x,n.y,n.radius,0,2*Math.PI),t.fill(),g||c){const h=Math.sin(Date.now()/100)*.5+2;t.beginPath(),t.arc(n.x,n.y,n.radius+h,0,2*Math.PI),t.strokeStyle=g?"rgba(251, 191, 36, 0.5)":"rgba(96, 165, 250, 0.5)",t.lineWidth=1.5,t.stroke()}}else if(n.type==="operator"&&d&&d.loaded&&!this.isLiveMode){r=!0,t.save(),t.beginPath(),t.arc(n.x,n.y,n.radius,0,2*Math.PI),t.closePath(),t.clip();try{t.drawImage(d.img,n.x-n.radius,n.y-n.radius,n.radius*2,n.radius*2)}catch{t.fillStyle=ut,t.fill()}t.restore()}else if(n.type==="sponsorship"){t.beginPath();const g=n.daysLeft<7,h=g?Ns:te,p=g?"#fca5a5":"#fdba74",f=t.createRadialGradient(n.x-n.radius/3,n.y-n.radius/3,n.radius/10,n.x,n.y,n.radius);f.addColorStop(0,p),f.addColorStop(1,h),t.fillStyle=f,t.arc(n.x,n.y,n.radius,0,2*Math.PI),t.fill(),t.lineWidth=1.5,t.strokeStyle="rgba(255, 255, 255, 0.4)",t.stroke()}else n.type==="delegator"?(t.beginPath(),t.moveTo(n.x,n.y-n.radius),t.lineTo(n.x+n.radius*.866,n.y+n.radius*.5),t.lineTo(n.x-n.radius*.866,n.y+n.radius*.5),t.closePath(),t.fillStyle=Rs,t.fill()):n.type==="operator"&&!this.isLiveMode&&(t.beginPath(),t.fillStyle=ut,t.arc(n.x,n.y,n.radius,0,2*Math.PI),t.fill());if(n.type!=="live-node")if(this.selectedNodeId===n.id||c){if(t.lineWidth=4,t.strokeStyle=this.selectedNodeId===n.id?"#fbbf24":"#60a5fa",n.type==="delegator"?(t.beginPath(),t.moveTo(n.x,n.y-n.radius),t.lineTo(n.x+n.radius*.866,n.y+n.radius*.5),t.lineTo(n.x-n.radius*.866,n.y+n.radius*.5),t.closePath(),t.stroke()):(t.beginPath(),t.arc(n.x,n.y,n.radius,0,2*Math.PI),t.stroke()),n.type!=="delegator"){const g=Math.sin(Date.now()/200)*2+6;t.beginPath(),t.arc(n.x,n.y,n.radius+g,0,2*Math.PI),t.strokeStyle=this.selectedNodeId===n.id?"rgba(251, 191, 36, 0.5)":"rgba(96, 165, 250, 0.5)",t.lineWidth=2,t.stroke()}}else this.hoveredNode===n?(t.lineWidth=2,t.strokeStyle="#fff",n.type==="delegator"?(t.beginPath(),t.moveTo(n.x,n.y-n.radius),t.lineTo(n.x+n.radius*.866,n.y+n.radius*.5),t.lineTo(n.x-n.radius*.866,n.y+n.radius*.5),t.closePath(),t.stroke()):(t.beginPath(),t.arc(n.x,n.y,n.radius,0,2*Math.PI),t.shadowBlur=15,t.shadowColor=n.type==="operator"?ut:te,t.stroke(),t.shadowBlur=0)):r&&(t.beginPath(),t.arc(n.x,n.y,n.radius,0,2*Math.PI),t.strokeStyle=ut,t.lineWidth=2,t.stroke())}),t.fillStyle="#fff",t.font="500 10px Inter",t.textAlign="center",this.nodes.forEach(n=>{const r=this.selectedOperatorId&&(n.type==="live-node"&&n.operatorId===this.selectedOperatorId||n.type==="operator"&&n.id===this.selectedOperatorId);if(n.type==="sponsorship"||n.type==="operator"||this.hoveredNode===n||this.selectedNodeId===n.id||r||this.transform.k>2){if(n.type==="delegator"&&this.transform.k<2.5&&this.hoveredNode!==n||n.type==="live-node"&&this.transform.k<2.5&&this.hoveredNode!==n&&this.selectedNodeId!==n.id&&!r||n.type==="live-node"&&!r&&this.selectedNodeId!==n.id&&this.hoveredNode!==n)return;this.selectedNodeId===n.id?t.font="bold 12px Inter":t.font="500 10px Inter";let d=n.label;if(n.type==="live-node"&&r){const c=this.operatorNodeMetadata.get(n.operatorId);c&&(d=c.label)}t.fillText(d.substring(0,18),n.x,n.y+n.radius+14)}}),t.restore(),(this.selectedNodeId||this.isLiveMode||this.selectedOperatorId)&&this.requestRender()},zoomed:function(t){this.transform=t.transform,this.requestRender()},mouseMoved:function(t){const[e,s]=d3.pointer(t,this.canvas),a=(e-this.transform.x)/this.transform.k,i=(s-this.transform.y)/this.transform.k;let o=null;for(let l=this.nodes.length-1;l>=0;l--){const n=this.nodes[l],r=n.radius+(n.type==="live-node"?20:0),d=a-n.x,c=i-n.y;if(d*d+c*c<r*r){o=n;break}}if(o!==this.hoveredNode)this.hoveredNode=o,this.requestRender(),this.updateTooltip(o,t.clientX,t.clientY);else if(o)this.updateTooltip(o,t.clientX,t.clientY);else{const l=document.getElementById("vis-tooltip");l&&(l.style.opacity=0)}},updateTooltip:function(t,e,s){if(window.matchMedia("(pointer: coarse)").matches){const n=document.getElementById("vis-tooltip");n&&(n.style.opacity=0);return}if(t&&this.selectedNodeId===t.id){const n=document.getElementById("vis-tooltip");n&&(n.style.opacity=0);return}const a=document.getElementById("vis-tooltip");if(!a)return;if(!t){a.style.opacity=0;return}let i="";if(t.type==="sponsorship")i=`<div class="font-bold text-orange-400 mb-1 text-sm">${t.label}</div>
                    <div class="text-gray-300">Balance: <span class="text-white font-mono">${Math.floor(t.val).toLocaleString()}</span></div>`;else if(t.type==="operator"){const n=this.operatorNodeMetadata.get(t.id),r=n&&n.delegatorCount?Math.max(0,n.delegatorCount-1):0;i=`<div class="font-bold text-blue-400 mb-1 text-sm">${t.label}</div>
                    <div class="text-gray-300">Stake: <span class="text-white font-mono">${Math.floor(t.val).toLocaleString()}</span></div>
                    <div class="text-gray-300">Delegators: <span class="text-white font-mono">${r}</span></div>`}else if(t.type==="delegator")i=`<div class="font-bold text-orange-400 mb-1 text-sm">Delegator</div>
                    <div class="text-xs text-gray-500 mb-1 font-mono">${t.id.substring(0,10)}...</div>
                    <div class="text-gray-300">Delegated: <span class="text-white font-mono">${Math.floor(t.val).toLocaleString()}</span></div>`;else if(t.type==="live-node"){const n=this.operatorNodeMetadata.get(t.operatorId),r=n?n.label:t.operatorId.substring(0,12)+"...",d=n?.redundancyFactor?`<div class="text-gray-300">Redundancy Factor: <span class="text-white font-mono">${n.redundancyFactor}</span></div>`:"",c=`Node #${t.nodeIndex}`;let g=0;const h=this.operatorNodeCounts.get(t.operatorId);h&&(g=h.size),i=`<div class="font-bold text-green-400 mb-1 text-sm">${r}</div>
                    <div class="text-gray-300">ID: <span class="text-white font-mono">${c}</span></div>
                    ${d}
                    <div class="text-gray-300">Fleet Size: <span class="text-white font-mono">${g}</span></div>`}a.innerHTML=i;let o=e+15,l=s+15;o+200>window.innerWidth&&(o=e-215),l+80>window.innerHeight&&(l=s-95),a.style.left=o+"px",a.style.top=l+"px",a.style.opacity=1}};let u={signer:null,myRealAddress:"",currentOperatorId:null,currentOperatorData:null,currentDelegations:[],sponsorshipHistory:[],operatorDailyBuckets:[],historicalDataPriceMap:null,chartTimeFrame:90,totalDelegatorCount:0,dataPriceUSD:null,loadedOperatorCount:0,searchQuery:"",searchTimeout:null,detailsRefreshInterval:null,activeSponsorshipMenu:null,uiState:{isStatsPanelExpanded:!1,isDelegatorViewActive:!0,reputationViewIndex:0,walletViewIndex:0,isSponsorshipsListViewActive:!0,isChartUsdView:!1},activeNodes:new Set,unreachableNodes:new Set};async function Ee(){await rs();try{const t=new StreamrClient;ns(t),console.log("Streamr client initialized."),u.historicalDataPriceMap=await Ue(),await os(e=>{u.dataPriceUSD=e}),await ot(),he.classList.add("hidden"),pt.classList.remove("hidden")}catch(t){console.error("Initialization failed:",t),I("Initialization Error",`Failed to initialize the application: ${t.message}`),at("buttons")}}function Us(){window.ethereum&&(window.ethereum.on("accountsChanged",()=>{console.log("Wallet account changed, reloading page."),window.location.reload()}),window.ethereum.on("chainChanged",()=>{console.log("Wallet network changed, reloading page."),window.location.reload()}))}async function se(){const t=window.ethereum||window.top?.ethereum;if(!t){I("MetaMask Not Found","Please install the MetaMask extension.");return}try{at("loading","wallet");const e=new ethers.providers.Web3Provider(t);if(await e.send("eth_requestAccounts",[]),u.signer=e.getSigner(),u.myRealAddress=await u.signer.getAddress(),!await bt()){at("buttons");return}pe(u.myRealAddress),Us(),await Ee(),sessionStorage.setItem("authMethod","metamask")}catch(e){console.error("Wallet connection error:",e),u.myRealAddress="",u.signer=null,q.classList.add("hidden");const s=e.code===4001||e.info?.error?.code===4001?"The signature request was rejected in your wallet.":"Wallet connection request was rejected or failed.";I("Wallet Connection Failed",s),at("buttons")}}async function Vs(){at("loading","guest"),u.myRealAddress="",u.signer=null,pe(null),sessionStorage.removeItem("authMethod"),await Ee()}async function ot(t=!1,e=0,s=""){vt(!t);try{const a=await _e(e,s);t?ps(a):gs(a,s),(!s||s.toLowerCase().startsWith("0x"))&&(u.loadedOperatorCount+=a.length),cs.style.display=a.length===Tt&&(!s||s.toLowerCase().startsWith("0x"))?"inline-block":"none"}catch(a){console.error("Failed to fetch operators:",a),mt.innerHTML=`<p class="text-red-400 col-span-full">${D(a.message)}</p>`}finally{vt(!1)}}async function _s(t){vt(!0),u.detailsRefreshInterval&&clearInterval(u.detailsRefreshInterval),u.currentOperatorId=t.toLowerCase(),u.activeNodes.clear(),u.unreachableNodes.clear(),u.chartTimeFrame=90,u.uiState.isChartUsdView=!1;try{await V(!0),u.detailsRefreshInterval=setInterval(()=>V(!1),3e4)}catch(e){ft.innerHTML=`<p class="text-red-400">${D(e.message)}</p>`}finally{vt(!1)}}async function V(t=!1){try{const e=await je(u.currentOperatorId);if(u.currentOperatorData=e.operator,u.currentDelegations=e.operator?.delegations||[],u.totalDelegatorCount=e.operator?.delegatorCount||0,u.operatorDailyBuckets=e.operatorDailyBuckets||[],t){let s=[];try{s=await qe(u.currentOperatorId)}catch(i){console.error("Failed to load Polygonscan history:",i)}js(e,s),ys(e,u);const a=[...e.operator.controllers||[],...e.operator.nodes||[]];Kt(a),ne(),rn(),xt(),fe(u.sponsorshipHistory)}else{ye(e,u);const s=[...e.operator.controllers||[],...e.operator.nodes||[]];Kt(s),ne(),xt()}}catch(e){console.error("Failed to refresh operator data:",e),t&&(ft.innerHTML=`<p class="text-red-400">${D(e.message)}</p>`)}}function js(t,e){const s=new Map;(t.stakingEvents||[]).forEach(i=>{const o=Number(i.date);s.has(o)||s.set(o,{timestamp:o,events:[]}),s.get(o).events.push({timestamp:o,type:"graph",amount:parseFloat(B(i.amount)),token:"DATA",methodId:"Staking Event",txHash:null,relatedObject:i.sponsorship})}),(e||[]).forEach(i=>{const o=Number(i.timestamp);s.has(o)||s.set(o,{timestamp:o,events:[]}),s.get(o).events.push({timestamp:o,type:"scan",amount:i.amount,token:i.token,methodId:i.methodId,txHash:i.txHash,relatedObject:i.direction})});const a=Array.from(s.values());a.sort((i,o)=>o.timestamp-i.timestamp),u.sponsorshipHistory=a}function xt(){const t=new Date;let e=u.dataPriceUSD||0;const s=u.operatorDailyBuckets.map(a=>{const i=a.date;if(u.chartTimeFrame!=="all"){const g=new Date(i*1e3);if((t-g)/(1e3*60*60*24)>u.chartTimeFrame)return null}const o=parseFloat(B(a.valueWithoutEarnings));let l;if(u.uiState.isChartUsdView){let g=u.historicalDataPriceMap.get(i);if(!g)for(let p=1;p<=7;p++){const f=i-p*86400;if(g=u.historicalDataPriceMap.get(f),g)break}const h=g||e;h>0&&(e=h),l=o*h}else l=o;const n=new Date(i*1e3),r=n.toLocaleDateString(void 0,{month:"short"}),d=n.getDate(),c=n.getFullYear().toString().substring(2);return{label:`${r} ${d} '${c}`,value:l}}).filter(Boolean);ms(s,u.uiState.isChartUsdView),xs(u.chartTimeFrame,u.uiState.isChartUsdView)}async function ne(){if(!u.myRealAddress)return;const t=document.getElementById("my-stake-section"),e=document.getElementById("my-stake-value");if(!t||!e)return;t.classList.remove("hidden"),e.textContent="Loading...";const s=await ts(u.currentOperatorId,u.myRealAddress,u.signer),a=B(s);e.textContent=`${O(a)} DATA`,e.setAttribute("data-tooltip-value",a)}function Gs(t){Z("detail"),u.uiState.reputationViewIndex=0,u.uiState.walletViewIndex=0,u.uiState.isSponsorshipsListViewActive=!0,_s(t)}function qs(){Z("race"),Ce.init()}function zs(){Ce.stop(),Z("list")}function Js(){Z("visual"),Rt.setClient(as()),Rt.init()}function Ks(){Rt.stop(),Z("list")}async function Ys(t){t.disabled=!0,t.innerHTML='<div class="w-4 h-4 border-2 border-white rounded-full border-t-transparent btn-spinner"></div> Loading...';try{await ot(!0,u.loadedOperatorCount,u.searchQuery)}catch(e){console.error("Failed to load more operators:",e)}finally{t.disabled=!1,t.innerHTML="Load More Operators"}}function Qs(t){u.searchTimeout&&clearTimeout(u.searchTimeout),u.searchTimeout=setTimeout(()=>{const e=t.trim();u.searchQuery!==e&&(u.searchQuery=e,u.loadedOperatorCount=0,ot(!1,0,u.searchQuery))},300)}async function Xs(t){t.disabled=!0,t.innerHTML='<div class="w-4 h-4 border-2 border-white rounded-full border-t-transparent btn-spinner"></div> Loading...';try{const e=await Ge(u.currentOperatorId,u.currentDelegations.length);u.currentDelegations.push(...e),Vt(u.currentDelegations,u.totalDelegatorCount)}catch(e){console.error("Failed to load more delegators:",e)}finally{t.disabled=!1,t.textContent="Load More"}}async function Zs(){if(!u.signer){I("Action Required","Please connect a wallet to delegate.");return}if(!await bt())return;let t=await ce(!0,"delegate",u.signer,u.myRealAddress,u.currentOperatorId);const e=document.getElementById("tx-modal-confirm"),s=e.cloneNode(!0);e.parentNode.replaceChild(s,e),document.getElementById("tx-modal-max-btn").onclick=()=>{t!=="0"&&(wt.value=ethers.utils.formatEther(t))},s.addEventListener("click",async()=>{s.disabled=!0,s.innerHTML='<div class="w-4 h-4 border-2 border-white rounded-full border-t-transparent btn-spinner"></div> Processing...',await Je(u.signer,u.myRealAddress,u.currentOperatorId)&&await V(!0),s.disabled=!1,s.textContent="Confirm"})}async function tn(){if(!u.signer){I("Action Required","Please connect a wallet to undelegate.");return}if(!await bt())return;let t=await ce(!0,"undelegate",u.signer,u.myRealAddress,u.currentOperatorId);const e=document.getElementById("tx-modal-confirm"),s=e.cloneNode(!0);e.parentNode.replaceChild(s,e),document.getElementById("tx-modal-max-btn").onclick=()=>{t!=="0"&&(wt.value=ethers.utils.formatEther(t))},s.addEventListener("click",async()=>{s.disabled=!0,s.innerHTML='<div class="w-4 h-4 border-2 border-white rounded-full border-t-transparent btn-spinner"></div> Processing...',await Ke(u.signer,u.myRealAddress,u.currentOperatorId)&&await V(!0),s.disabled=!1,s.textContent="Confirm"})}async function en(t){if(!u.signer){I("Action Required","Please connect your wallet.");return}t.disabled=!0,t.innerHTML='<div class="w-4 h-4 border-2 border-white rounded-full border-t-transparent btn-spinner"></div> Processing...',await Ye(u.signer,u.currentOperatorId),await V(!0),t.disabled=!1,t.innerHTML="Process Queue"}async function sn(t,e){if(!u.signer){I("Action Required","Please connect your wallet.");return}w("stake-modal","input"),yt.classList.remove("hidden");const s=B(e);hs.textContent=`${O(s)} DATA`,Bt.value=parseFloat(s);try{const l=await new ethers.Contract(Ft,Ht,u.signer.provider).balanceOf(u.currentOperatorId);Jt.textContent=`${O(B(l))} DATA`;const n=ethers.BigNumber.from(e).add(l).toString();document.getElementById("stake-modal-max-btn").onclick=()=>{Bt.value=ethers.utils.formatEther(n)}}catch(o){console.error("Failed to get free funds:",o),Jt.textContent="Error"}const a=document.getElementById("stake-modal-confirm"),i=a.cloneNode(!0);a.parentNode.replaceChild(i,a),i.addEventListener("click",async()=>{i.disabled=!0,i.innerHTML='<div class="w-4 h-4 border-2 border-white rounded-full border-t-transparent btn-spinner"></div> Processing...';const o=await Qe(u.signer,u.currentOperatorId,t,e);o&&o!=="nochange"&&await V(!0),i.disabled=!1,i.textContent="Confirm"})}async function nn(t,e){if(!u.signer){I("Action Required","Please connect your wallet.");return}t.classList.add("processing");const s=t.textContent;t.textContent="Processing...",await Xe(u.signer,u.currentOperatorId,e),await V(!0),t.classList.remove("processing"),t.textContent=s}async function an(t){if(!u.signer){I("Action Required","Please connect your wallet.");return}t.disabled=!0,t.innerHTML='<div class_ = "w-4 h-4 border-2 border-white rounded-full border-t-transparent btn-spinner"></div>',await Ze(u.signer,u.currentOperatorId,u.currentOperatorData),await V(!0),t.disabled=!1,t.textContent="Collect All"}async function on(){if(!u.signer){I("Action Required","Please connect your wallet.");return}if(!await bt())return;fs(u.currentOperatorData),w("operator-settings-modal","input");const t=document.getElementById("operator-settings-modal-confirm"),e=t.cloneNode(!0);t.parentNode.replaceChild(e,t);const s=()=>{e.disabled=!1};Ot.addEventListener("input",s,{once:!0}),Nt.addEventListener("input",s,{once:!0}),Pt.addEventListener("input",s,{once:!0}),$t.addEventListener("input",s,{once:!0}),e.addEventListener("click",async()=>{e.disabled=!0,e.innerHTML='<div class="w-4 h-4 border-2 border-white rounded-full border-t-transparent btn-spinner"></div> Processing...',w("operator-settings-modal","loading",{text:"Checking for changes...",subtext:"Please wait."});const a=X(u.currentOperatorData.metadataJsonString);let i="1";try{if(u.currentOperatorData.metadataJsonString){const f=JSON.parse(u.currentOperatorData.metadataJsonString);f&&f.redundancyFactor!==void 0&&(i=String(f.redundancyFactor))}}catch{}const o=BigInt(u.currentOperatorData.operatorsCutFraction)*100n/BigInt("1000000000000000000"),l=Ot.value,n=Nt.value,r=$t.value,d=Pt.value,c=l!==(a.name||"")||n!==(a.description||"")||r!==i,g=d!==o.toString();if(!c&&!g){w("operator-settings-modal","input"),I("No Changes","You have not made any changes."),e.disabled=!1,e.textContent="Confirm Changes";return}let h=null,p=null;try{if(c){w("operator-settings-modal","loading",{text:"Updating Metadata...",subtext:"Please confirm in your wallet."});const f={name:l,description:n,imageIpfsCid:a.imageUrl?a.imageUrl.split("/").pop():null,redundancyFactor:parseInt(r,10)};if(h=await es(u.signer,u.currentOperatorId,JSON.stringify(f)),!h){e.disabled=!1,e.textContent="Confirm Changes";return}}if(g&&(w("operator-settings-modal","loading",{text:"Updating Owner's Cut...",subtext:"Please confirm in your wallet."}),p=await ss(u.signer,u.currentOperatorId,d),!p)){e.disabled=!1,e.textContent="Confirm Changes";return}w("operator-settings-modal","success",{txHash:h,tx1Text:h?"Metadata Update Successful!":"",txHash2:p,tx2Text:p?"Owner's Cut Update Successful!":""}),await V(!0)}catch(f){w("operator-settings-modal","error",{message:W(f)})}finally{e.disabled=!1,e.textContent="Confirm Changes"}})}function rn(){is(u.currentOperatorId,t=>{bs(t,u.activeNodes,u.unreachableNodes)})}function ln(){document.getElementById("connectWalletBtn").addEventListener("click",se),document.getElementById("guestBtn").addEventListener("click",Vs),document.getElementById("closeAlertBtn").addEventListener("click",()=>ge.classList.add("hidden")),q.addEventListener("click",()=>{u.myRealAddress||se()}),ds.addEventListener("input",i=>Qs(i.target.value)),document.getElementById("load-more-operators-btn").addEventListener("click",i=>Ys(i.target)),document.getElementById("back-to-list-btn").addEventListener("click",()=>{u.detailsRefreshInterval&&clearInterval(u.detailsRefreshInterval),Ut(),Z("list"),u.loadedOperatorCount=0,ot(!1,0,u.searchQuery)});const t=document.getElementById("race-view-btn");t&&t.addEventListener("click",qs);const e=document.getElementById("race-back-to-list-btn");e&&e.addEventListener("click",zs);const s=document.getElementById("visual-view-btn");s&&s.addEventListener("click",Js);const a=document.getElementById("vis-btn-back");a&&a.addEventListener("click",Ks),document.getElementById("tx-modal-cancel").addEventListener("click",()=>Q.classList.add("hidden")),document.getElementById("tx-modal-close").addEventListener("click",()=>Q.classList.add("hidden")),document.getElementById("stake-modal-cancel").addEventListener("click",()=>yt.classList.add("hidden")),document.getElementById("stake-modal-close").addEventListener("click",()=>yt.classList.add("hidden")),document.getElementById("operator-settings-modal-cancel").addEventListener("click",()=>At.classList.add("hidden")),document.getElementById("operator-settings-modal-close").addEventListener("click",()=>At.classList.add("hidden")),document.getElementById("settings-btn").addEventListener("click",()=>{zt.value=localStorage.getItem("the-graph-api-key")||"",document.getElementById("etherscan-api-key-input").value=localStorage.getItem("etherscan-api-key")||"",Et.classList.remove("hidden")}),document.getElementById("settings-cancel-btn").addEventListener("click",()=>Et.classList.add("hidden")),document.getElementById("settings-save-btn").addEventListener("click",()=>{const i=zt.value.trim();i?localStorage.setItem("the-graph-api-key",i):localStorage.removeItem("the-graph-api-key"),He(i);const o=document.getElementById("etherscan-api-key-input").value.trim();o?localStorage.setItem("etherscan-api-key",o):localStorage.removeItem("etherscan-api-key"),We(o),Et.classList.add("hidden"),I("Settings Saved","Data will be refreshed with the new API keys."),u.loadedOperatorCount=0,ot(!1,0,u.searchQuery)}),document.body.addEventListener("click",i=>{const o=i.target,l=o.closest(".card, .operator-link");if(l&&l.dataset.operatorId){i.preventDefault(),Gs(l.dataset.operatorId);return}o.id==="delegate-btn"&&Zs(),o.id==="undelegate-btn"&&tn(),o.id==="process-queue-btn"&&en(o),o.id==="collect-all-earnings-btn"&&an(o),o.id==="load-more-delegators-btn"&&Xs(o),o.id==="edit-operator-settings-btn"&&on(),o.closest("#toggle-stats-btn")&&ve(!1,u.uiState),o.id==="toggle-delegator-view-btn"&&(xe(u.currentOperatorData,u.uiState),u.uiState.isDelegatorViewActive&&Vt(u.currentDelegations,u.totalDelegatorCount)),o.id==="toggle-reputation-view-btn"&&be(!1,u.uiState),o.id==="toggle-wallets-view-btn"&&we(!1,u.uiState),o.id==="toggle-sponsorship-view-btn"&&(Se(u.uiState,u.currentOperatorData),u.uiState.isSponsorshipsListViewActive||fe(u.sponsorshipHistory)),o.closest(".toggle-vote-list-btn")&&vs(o.closest(".toggle-vote-list-btn").dataset.flagId);const n=o.closest("#chart-timeframe-buttons button");if(n&&n.dataset.days){const h=n.dataset.days==="all"?"all":parseInt(n.dataset.days,10);u.chartTimeFrame=h,xt();return}const r=o.closest("#chart-view-buttons button");if(r&&r.dataset.view){u.uiState.isChartUsdView=r.dataset.view==="usd",xt();return}const d=o.closest(".toggle-sponsorship-menu-btn");if(d){i.stopPropagation();const h=d.dataset.sponsorshipId,p=document.getElementById(`sponsorship-menu-${h}`);u.activeSponsorshipMenu&&u.activeSponsorshipMenu!==p&&u.activeSponsorshipMenu.classList.add("hidden"),p.classList.toggle("hidden"),u.activeSponsorshipMenu=p.classList.contains("hidden")?null:p}else u.activeSponsorshipMenu&&(u.activeSponsorshipMenu.classList.add("hidden"),u.activeSponsorshipMenu=null);const c=o.closest(".edit-stake-link");c&&(i.preventDefault(),sn(c.dataset.sponsorshipId,c.dataset.currentStake));const g=o.closest(".collect-earnings-link");if(g){if(i.preventDefault(),g.classList.contains("processing"))return;nn(g,g.dataset.sponsorshipId)}}),pt.addEventListener("mouseover",i=>{const o=i.target.closest("[data-tooltip-value], [data-tooltip-content]");if(!o)return;const l=o.dataset.tooltipContent||ie(o.dataset.tooltipValue,u.dataPriceUSD);l&&(K.textContent=l,K.classList.remove("hidden"))}),pt.addEventListener("mousemove",i=>{K.classList.contains("hidden")||(K.style.left=`${i.pageX+15}px`,K.style.top=`${i.pageY+15}px`)}),pt.addEventListener("mouseout",i=>{i.target.closest("[data-tooltip-value], [data-tooltip-content]")&&K.classList.add("hidden")})}document.addEventListener("DOMContentLoaded",()=>{ln(),he.classList.remove("hidden")});
